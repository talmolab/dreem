
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://dreem.sleap.ai/dev/reference/dreem/inference/batch_tracker/">
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../boxes/">
      
      
      <link rel="icon" href="../../../../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    
    
      
        <title>batch_tracker - DREEM documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        
        <link rel="stylesheet" href="../../../../assets/external/fonts.googleapis.com/css.49ea35f2.css">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../../css/mkdocstrings.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-V7MWLE7LXW"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-V7MWLE7LXW",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-V7MWLE7LXW",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="deep-orange" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#dreem.inference.batch_tracker" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="DREEM documentation" class="md-header__button md-logo" aria-label="DREEM documentation" data-md-component="logo">
      
  <img src="../../../../assets/sleap-logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DREEM documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              batch_tracker
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="deep-orange" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-orange" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/talmolab/dreem" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="DREEM documentation" class="md-nav__button md-logo" aria-label="DREEM documentation" data-md-component="logo">
      
  <img src="../../../../assets/sleap-logo.png" alt="logo">

    </a>
    DREEM documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/talmolab/dreem" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quickstart
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Usage
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Examples/microscopy-demo-simple/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Microscopy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Examples/microscopy-demo-full-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Microscopy - in-depth API usage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Examples/dreem-demo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    End-to-end
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Core API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Core API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../io/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    i/o
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_1" id="__nav_6_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1">
            <span class="md-nav__icon md-icon"></span>
            i/o
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../io/asso_matrix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AssociationMatrix
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../io/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Config
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../io/frame/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Frame
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../io/instance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Instance
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../io/track/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Track
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../io/visualize/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    visualize
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../models/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    models
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../models/global_tracking_transformer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GlobalTrackingTransformer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../models/gtr_runner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GTRRunner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../models/model_parts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Model Parts
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../configs/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    configs
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            configs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../configs/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Config Parser
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../configs/eval/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Description of inference params
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../configs/inference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Description of inference params
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../configs/training/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Description of training parameters
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    cli
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Full API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Full API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    dreem
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1" id="__nav_7_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7_1">
            <span class="md-nav__icon md-icon"></span>
            dreem
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    cli
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../datasets/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    datasets
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1_2" id="__nav_7_1_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_2">
            <span class="md-nav__icon md-icon"></span>
            datasets
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datasets/base_dataset/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    base_dataset
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datasets/cell_tracking_dataset/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    cell_tracking_dataset
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datasets/data_utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    data_utils
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datasets/microscopy_dataset/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    microscopy_dataset
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datasets/sleap_dataset/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    sleap_dataset
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datasets/tracking_dataset/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    tracking_dataset
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_3" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    inference
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1_3" id="__nav_7_1_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7_1_3">
            <span class="md-nav__icon md-icon"></span>
            inference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    batch_tracker
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    batch_tracker
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dreem.inference.batch_tracker" class="md-nav__link">
    <span class="md-ellipsis">
      batch_tracker
    </span>
  </a>
  
    <nav class="md-nav" aria-label="batch_tracker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dreem.inference.batch_tracker.BatchTracker" class="md-nav__link">
    <span class="md-ellipsis">
      BatchTracker
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../boxes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    boxes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../eval/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    eval
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    metrics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../post_processing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    post_processing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../track/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    track
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../track_queue/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    track_queue
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tracker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    tracker
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../io/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    io
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1_4" id="__nav_7_1_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_4">
            <span class="md-nav__icon md-icon"></span>
            io
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../io/association_matrix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    association_matrix
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../io/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    config
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../io/frame/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    frame
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../io/instance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    instance
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../io/track/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    track
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../io/visualize/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    visualize
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../models/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    models
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1_5" id="__nav_7_1_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_5">
            <span class="md-nav__icon md-icon"></span>
            models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/attention_head/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    attention_head
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/embedding/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    embedding
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/global_tracking_transformer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    global_tracking_transformer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/gtr_runner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    gtr_runner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/mlp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    mlp
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/model_utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    model_utils
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/transformer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    transformer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/visual_encoder/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    visual_encoder
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../training/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    training
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1_6" id="__nav_7_1_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_6">
            <span class="md-nav__icon md-icon"></span>
            training
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../training/losses/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    losses
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../training/train/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    train
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../version/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    version
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/talmolab/dreem/releases" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Changelog
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dreem.inference.batch_tracker" class="md-nav__link">
    <span class="md-ellipsis">
      batch_tracker
    </span>
  </a>
  
    <nav class="md-nav" aria-label="batch_tracker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dreem.inference.batch_tracker.BatchTracker" class="md-nav__link">
    <span class="md-ellipsis">
      BatchTracker
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>batch_tracker</h1>

<div class="doc doc-object doc-module">



<h2 id="dreem.inference.batch_tracker" class="doc doc-heading">
            <code>dreem.inference.batch_tracker</code>


<a href="#dreem.inference.batch_tracker" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">

        <p>Module containing logic for going from association -&gt; assignment.</p>








<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="&lt;code&gt;BatchTracker&lt;/code&gt; (&lt;code&gt;dreem.inference.batch_tracker.BatchTracker&lt;/code&gt;)" href="#dreem.inference.batch_tracker.BatchTracker">BatchTracker</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Tracker class used for assignment based on sliding inference from GTR.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="dreem.inference.batch_tracker.BatchTracker" class="doc doc-heading">
            <code>BatchTracker</code>


<a href="#dreem.inference.batch_tracker.BatchTracker" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">


        <p>Tracker class used for assignment based on sliding inference from GTR.</p>










<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="&lt;code class=&quot;highlight language-python&quot;&gt;&lt;span class=&quot;fm&quot;&gt;__call__&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;model&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt; (&lt;code&gt;dreem.inference.batch_tracker.BatchTracker.__call__&lt;/code&gt;)" href="#dreem.inference.batch_tracker.BatchTracker.__call__">__call__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Wrap around <code>track</code> to enable <code>tracker()</code> instead of <code>tracker.track()</code>.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="&lt;code class=&quot;highlight language-python&quot;&gt;&lt;span class=&quot;fm&quot;&gt;__init__&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;window_size&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;use_vis_feats&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;overlap_thresh&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.01&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mult_thresh&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;decay_time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;iou&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;max_center_dist&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;persistent_tracking&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;max_gap&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;inf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;max_tracks&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;inf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;verbose&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;False&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;**&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kwargs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt; (&lt;code&gt;dreem.inference.batch_tracker.BatchTracker.__init__&lt;/code&gt;)" href="#dreem.inference.batch_tracker.BatchTracker.__init__">__init__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Initialize a tracker to run inference.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="&lt;code class=&quot;highlight language-python&quot;&gt;&lt;span class=&quot;fm&quot;&gt;__repr__&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;/code&gt; (&lt;code&gt;dreem.inference.batch_tracker.BatchTracker.__repr__&lt;/code&gt;)" href="#dreem.inference.batch_tracker.BatchTracker.__repr__">__repr__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Get string representation of tracker.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="&lt;code class=&quot;highlight language-python&quot;&gt;&lt;span class=&quot;n&quot;&gt;track&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;model&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt; (&lt;code&gt;dreem.inference.batch_tracker.BatchTracker.track&lt;/code&gt;)" href="#dreem.inference.batch_tracker.BatchTracker.track">track</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Perform sliding inference on the input video (instances) with a given window size. This method is called once per batch.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="&lt;code class=&quot;highlight language-python&quot;&gt;&lt;span class=&quot;n&quot;&gt;track_by_batch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;model&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt; (&lt;code&gt;dreem.inference.batch_tracker.BatchTracker.track_by_batch&lt;/code&gt;)" href="#dreem.inference.batch_tracker.BatchTracker.track_by_batch">track_by_batch</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Perform sliding inference, on an entire batch of frames, on the input video (instances) with a given context length (window size).</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="&lt;code class=&quot;highlight language-python&quot;&gt;&lt;span class=&quot;n&quot;&gt;track_by_frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;model&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt; (&lt;code&gt;dreem.inference.batch_tracker.BatchTracker.track_by_frame&lt;/code&gt;)" href="#dreem.inference.batch_tracker.BatchTracker.track_by_frame">track_by_frame</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Perform sliding inference on the input video (instances) with a given window size.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



              <details class="quote">
                <summary>Source code in <code>dreem/inference/batch_tracker.py</code></summary>
                <div class="highlight"><pre><span></span><code><a id="__codelineno-0-18" name="__codelineno-0-18"></a><a href="#__codelineno-0-18"><span class="linenos" data-linenos=" 18 "></span></a><span class="k">class</span><span class="w"> </span><span class="nc">BatchTracker</span><span class="p">:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><a href="#__codelineno-0-19"><span class="linenos" data-linenos=" 19 "></span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Tracker class used for assignment based on sliding inference from GTR.&quot;&quot;&quot;</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><a href="#__codelineno-0-20"><span class="linenos" data-linenos=" 20 "></span></a>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><a href="#__codelineno-0-21"><span class="linenos" data-linenos=" 21 "></span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><a href="#__codelineno-0-22"><span class="linenos" data-linenos=" 22 "></span></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><a href="#__codelineno-0-23"><span class="linenos" data-linenos=" 23 "></span></a>        <span class="n">window_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><a href="#__codelineno-0-24"><span class="linenos" data-linenos=" 24 "></span></a>        <span class="n">use_vis_feats</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><a href="#__codelineno-0-25"><span class="linenos" data-linenos=" 25 "></span></a>        <span class="n">overlap_thresh</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><a href="#__codelineno-0-26"><span class="linenos" data-linenos=" 26 "></span></a>        <span class="n">mult_thresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><a href="#__codelineno-0-27"><span class="linenos" data-linenos=" 27 "></span></a>        <span class="n">decay_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><a href="#__codelineno-0-28"><span class="linenos" data-linenos=" 28 "></span></a>        <span class="n">iou</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><a href="#__codelineno-0-29"><span class="linenos" data-linenos=" 29 "></span></a>        <span class="n">max_center_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><a href="#__codelineno-0-30"><span class="linenos" data-linenos=" 30 "></span></a>        <span class="n">persistent_tracking</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><a href="#__codelineno-0-31"><span class="linenos" data-linenos=" 31 "></span></a>        <span class="n">max_gap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">inf</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><a href="#__codelineno-0-32"><span class="linenos" data-linenos=" 32 "></span></a>        <span class="n">max_tracks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">inf</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><a href="#__codelineno-0-33"><span class="linenos" data-linenos=" 33 "></span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><a href="#__codelineno-0-34"><span class="linenos" data-linenos=" 34 "></span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><a href="#__codelineno-0-35"><span class="linenos" data-linenos=" 35 "></span></a>    <span class="p">):</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><a href="#__codelineno-0-36"><span class="linenos" data-linenos=" 36 "></span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a tracker to run inference.</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><a href="#__codelineno-0-37"><span class="linenos" data-linenos=" 37 "></span></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><a href="#__codelineno-0-38"><span class="linenos" data-linenos=" 38 "></span></a><span class="sd">        Args:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><a href="#__codelineno-0-39"><span class="linenos" data-linenos=" 39 "></span></a><span class="sd">            window_size: the size of the window used during sliding inference.</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><a href="#__codelineno-0-40"><span class="linenos" data-linenos=" 40 "></span></a><span class="sd">            use_vis_feats: Whether or not to use visual feature extractor.</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><a href="#__codelineno-0-41"><span class="linenos" data-linenos=" 41 "></span></a><span class="sd">            overlap_thresh: the trajectory overlap threshold to be used for assignment.</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><a href="#__codelineno-0-42"><span class="linenos" data-linenos=" 42 "></span></a><span class="sd">            mult_thresh: Whether or not to use weight threshold.</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><a href="#__codelineno-0-43"><span class="linenos" data-linenos=" 43 "></span></a><span class="sd">            decay_time: weight for `decay_time` postprocessing.</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><a href="#__codelineno-0-44"><span class="linenos" data-linenos=" 44 "></span></a><span class="sd">            iou: Either [None, &#39;&#39;, &quot;mult&quot; or &quot;max&quot;]</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><a href="#__codelineno-0-45"><span class="linenos" data-linenos=" 45 "></span></a><span class="sd">                 Whether to use multiplicative or max iou reweighting.</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><a href="#__codelineno-0-46"><span class="linenos" data-linenos=" 46 "></span></a><span class="sd">            max_center_dist: distance threshold for filtering trajectory score matrix.</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><a href="#__codelineno-0-47"><span class="linenos" data-linenos=" 47 "></span></a><span class="sd">            persistent_tracking: whether to keep a buffer across chunks or not.</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><a href="#__codelineno-0-48"><span class="linenos" data-linenos=" 48 "></span></a><span class="sd">            max_gap: the max number of frames a trajectory can be missing before termination.</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><a href="#__codelineno-0-49"><span class="linenos" data-linenos=" 49 "></span></a><span class="sd">            max_tracks: the maximum number of tracks that can be created while tracking.</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><a href="#__codelineno-0-50"><span class="linenos" data-linenos=" 50 "></span></a><span class="sd">                We force the tracker to assign instances to a track instead of creating a new track if max_tracks has been reached.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><a href="#__codelineno-0-51"><span class="linenos" data-linenos=" 51 "></span></a><span class="sd">            verbose: Whether or not to turn on debug printing after each operation.</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><a href="#__codelineno-0-52"><span class="linenos" data-linenos=" 52 "></span></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><a href="#__codelineno-0-53"><span class="linenos" data-linenos=" 53 "></span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span> <span class="o">=</span> <span class="n">TrackQueue</span><span class="p">(</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><a href="#__codelineno-0-54"><span class="linenos" data-linenos=" 54 "></span></a>            <span class="n">window_size</span><span class="o">=</span><span class="n">window_size</span><span class="p">,</span> <span class="n">max_gap</span><span class="o">=</span><span class="n">max_gap</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><a href="#__codelineno-0-55"><span class="linenos" data-linenos=" 55 "></span></a>        <span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><a href="#__codelineno-0-56"><span class="linenos" data-linenos=" 56 "></span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_frames_tracked</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><a href="#__codelineno-0-57"><span class="linenos" data-linenos=" 57 "></span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">=</span> <span class="n">window_size</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><a href="#__codelineno-0-58"><span class="linenos" data-linenos=" 58 "></span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_vis_feats</span> <span class="o">=</span> <span class="n">use_vis_feats</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><a href="#__codelineno-0-59"><span class="linenos" data-linenos=" 59 "></span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlap_thresh</span> <span class="o">=</span> <span class="n">overlap_thresh</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><a href="#__codelineno-0-60"><span class="linenos" data-linenos=" 60 "></span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mult_thresh</span> <span class="o">=</span> <span class="n">mult_thresh</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><a href="#__codelineno-0-61"><span class="linenos" data-linenos=" 61 "></span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decay_time</span> <span class="o">=</span> <span class="n">decay_time</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><a href="#__codelineno-0-62"><span class="linenos" data-linenos=" 62 "></span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">iou</span> <span class="o">=</span> <span class="n">iou</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><a href="#__codelineno-0-63"><span class="linenos" data-linenos=" 63 "></span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_center_dist</span> <span class="o">=</span> <span class="n">max_center_dist</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><a href="#__codelineno-0-64"><span class="linenos" data-linenos=" 64 "></span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">persistent_tracking</span> <span class="o">=</span> <span class="n">persistent_tracking</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><a href="#__codelineno-0-65"><span class="linenos" data-linenos=" 65 "></span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><a href="#__codelineno-0-66"><span class="linenos" data-linenos=" 66 "></span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_tracks</span> <span class="o">=</span> <span class="n">max_tracks</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><a href="#__codelineno-0-67"><span class="linenos" data-linenos=" 67 "></span></a>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><a href="#__codelineno-0-68"><span class="linenos" data-linenos=" 68 "></span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><a href="#__codelineno-0-69"><span class="linenos" data-linenos=" 69 "></span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">GlobalTrackingTransformer</span><span class="p">,</span> <span class="n">frames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Frame</span><span class="p">]</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><a href="#__codelineno-0-70"><span class="linenos" data-linenos=" 70 "></span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Frame</span><span class="p">]:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><a href="#__codelineno-0-71"><span class="linenos" data-linenos=" 71 "></span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrap around `track` to enable `tracker()` instead of `tracker.track()`.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><a href="#__codelineno-0-72"><span class="linenos" data-linenos=" 72 "></span></a>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><a href="#__codelineno-0-73"><span class="linenos" data-linenos=" 73 "></span></a><span class="sd">        Args:</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><a href="#__codelineno-0-74"><span class="linenos" data-linenos=" 74 "></span></a><span class="sd">            model: the pretrained GlobalTrackingTransformer to be used for inference</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><a href="#__codelineno-0-75"><span class="linenos" data-linenos=" 75 "></span></a><span class="sd">            frames: list of Frames to run inference on</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><a href="#__codelineno-0-76"><span class="linenos" data-linenos=" 76 "></span></a>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><a href="#__codelineno-0-77"><span class="linenos" data-linenos=" 77 "></span></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><a href="#__codelineno-0-78"><span class="linenos" data-linenos=" 78 "></span></a><span class="sd">            List of frames containing association matrix scores and instances populated with pred track ids.</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><a href="#__codelineno-0-79"><span class="linenos" data-linenos=" 79 "></span></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><a href="#__codelineno-0-80"><span class="linenos" data-linenos=" 80 "></span></a>        <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><a href="#__codelineno-0-81"><span class="linenos" data-linenos=" 81 "></span></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><a href="#__codelineno-0-82"><span class="linenos" data-linenos=" 82 "></span></a>        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><a href="#__codelineno-0-83"><span class="linenos" data-linenos=" 83 "></span></a>            <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">has_instances</span><span class="p">():</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><a href="#__codelineno-0-84"><span class="linenos" data-linenos=" 84 "></span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_vis_feats</span><span class="p">:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><a href="#__codelineno-0-85"><span class="linenos" data-linenos=" 85 "></span></a>                    <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><a href="#__codelineno-0-86"><span class="linenos" data-linenos=" 86 "></span></a>                        <span class="n">instance</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">d_model</span><span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><a href="#__codelineno-0-87"><span class="linenos" data-linenos=" 87 "></span></a>                    <span class="c1"># frame[&quot;features&quot;] = torch.randn(</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><a href="#__codelineno-0-88"><span class="linenos" data-linenos=" 88 "></span></a>                    <span class="c1">#     num_frame_instances, self.model.d_model</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><a href="#__codelineno-0-89"><span class="linenos" data-linenos=" 89 "></span></a>                    <span class="c1"># )</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><a href="#__codelineno-0-90"><span class="linenos" data-linenos=" 90 "></span></a>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><a href="#__codelineno-0-91"><span class="linenos" data-linenos=" 91 "></span></a>                <span class="c1"># comment out to turn encoder off</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><a href="#__codelineno-0-92"><span class="linenos" data-linenos=" 92 "></span></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><a href="#__codelineno-0-93"><span class="linenos" data-linenos=" 93 "></span></a>                <span class="c1"># Assuming the encoder is already trained or train encoder jointly.</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><a href="#__codelineno-0-94"><span class="linenos" data-linenos=" 94 "></span></a>                <span class="k">elif</span> <span class="ow">not</span> <span class="n">frame</span><span class="o">.</span><span class="n">has_features</span><span class="p">():</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><a href="#__codelineno-0-95"><span class="linenos" data-linenos=" 95 "></span></a>                    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><a href="#__codelineno-0-96"><span class="linenos" data-linenos=" 96 "></span></a>                        <span class="n">crops</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">get_crops</span><span class="p">()</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><a href="#__codelineno-0-97"><span class="linenos" data-linenos=" 97 "></span></a>                        <span class="n">z</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">visual_encoder</span><span class="p">(</span><span class="n">crops</span><span class="p">)</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><a href="#__codelineno-0-98"><span class="linenos" data-linenos=" 98 "></span></a>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><a href="#__codelineno-0-99"><span class="linenos" data-linenos=" 99 "></span></a>                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">z_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><a href="#__codelineno-0-100"><span class="linenos" data-linenos="100 "></span></a>                            <span class="n">frame</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">z_i</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><a href="#__codelineno-0-101"><span class="linenos" data-linenos="101 "></span></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><a href="#__codelineno-0-102"><span class="linenos" data-linenos="102 "></span></a>        <span class="n">instances_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">frames</span><span class="p">)</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><a href="#__codelineno-0-103"><span class="linenos" data-linenos="103 "></span></a>        <span class="c1"># no more persistent tracking. It is on by default</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><a href="#__codelineno-0-104"><span class="linenos" data-linenos="104 "></span></a>        <span class="c1"># if not self.persistent_tracking:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><a href="#__codelineno-0-105"><span class="linenos" data-linenos="105 "></span></a>        <span class="c1">#     logger.debug(f&quot;Clearing Queue after tracking&quot;)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><a href="#__codelineno-0-106"><span class="linenos" data-linenos="106 "></span></a>        <span class="c1">#     self.track_queue.end_tracks()</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><a href="#__codelineno-0-107"><span class="linenos" data-linenos="107 "></span></a>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><a href="#__codelineno-0-108"><span class="linenos" data-linenos="108 "></span></a>        <span class="k">return</span> <span class="n">instances_pred</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><a href="#__codelineno-0-109"><span class="linenos" data-linenos="109 "></span></a>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><a href="#__codelineno-0-110"><span class="linenos" data-linenos="110 "></span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><a href="#__codelineno-0-111"><span class="linenos" data-linenos="111 "></span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get string representation of tracker.</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><a href="#__codelineno-0-112"><span class="linenos" data-linenos="112 "></span></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><a href="#__codelineno-0-113"><span class="linenos" data-linenos="113 "></span></a><span class="sd">        Returns: the string representation of the tracker</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><a href="#__codelineno-0-114"><span class="linenos" data-linenos="114 "></span></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><a href="#__codelineno-0-115"><span class="linenos" data-linenos="115 "></span></a>        <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><a href="#__codelineno-0-116"><span class="linenos" data-linenos="116 "></span></a>            <span class="s2">&quot;Tracker(&quot;</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><a href="#__codelineno-0-117"><span class="linenos" data-linenos="117 "></span></a>            <span class="sa">f</span><span class="s2">&quot;persistent_tracking=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">persistent_tracking</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><a href="#__codelineno-0-118"><span class="linenos" data-linenos="118 "></span></a>            <span class="sa">f</span><span class="s2">&quot;max_tracks=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_tracks</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><a href="#__codelineno-0-119"><span class="linenos" data-linenos="119 "></span></a>            <span class="sa">f</span><span class="s2">&quot;use_vis_feats=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">use_vis_feats</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><a href="#__codelineno-0-120"><span class="linenos" data-linenos="120 "></span></a>            <span class="sa">f</span><span class="s2">&quot;overlap_thresh=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">overlap_thresh</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><a href="#__codelineno-0-121"><span class="linenos" data-linenos="121 "></span></a>            <span class="sa">f</span><span class="s2">&quot;mult_thresh=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mult_thresh</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><a href="#__codelineno-0-122"><span class="linenos" data-linenos="122 "></span></a>            <span class="sa">f</span><span class="s2">&quot;decay_time=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">decay_time</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><a href="#__codelineno-0-123"><span class="linenos" data-linenos="123 "></span></a>            <span class="sa">f</span><span class="s2">&quot;max_center_dist=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_center_dist</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><a href="#__codelineno-0-124"><span class="linenos" data-linenos="124 "></span></a>            <span class="sa">f</span><span class="s2">&quot;verbose=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><a href="#__codelineno-0-125"><span class="linenos" data-linenos="125 "></span></a>            <span class="sa">f</span><span class="s2">&quot;queue=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><a href="#__codelineno-0-126"><span class="linenos" data-linenos="126 "></span></a>        <span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><a href="#__codelineno-0-127"><span class="linenos" data-linenos="127 "></span></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><a href="#__codelineno-0-128"><span class="linenos" data-linenos="128 "></span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">track</span><span class="p">(</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><a href="#__codelineno-0-129"><span class="linenos" data-linenos="129 "></span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">GlobalTrackingTransformer</span><span class="p">,</span> <span class="n">frames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Frame</span><span class="p">]</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><a href="#__codelineno-0-130"><span class="linenos" data-linenos="130 "></span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Frame</span><span class="p">]:</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><a href="#__codelineno-0-131"><span class="linenos" data-linenos="131 "></span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform sliding inference on the input video (instances) with a given window size. This method is called once per batch.</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><a href="#__codelineno-0-132"><span class="linenos" data-linenos="132 "></span></a>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><a href="#__codelineno-0-133"><span class="linenos" data-linenos="133 "></span></a><span class="sd">        Args:</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><a href="#__codelineno-0-134"><span class="linenos" data-linenos="134 "></span></a><span class="sd">            model: the pretrained GlobalTrackingTransformer to be used for inference</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><a href="#__codelineno-0-135"><span class="linenos" data-linenos="135 "></span></a><span class="sd">            frames: A list of Frames (See `dreem.io.Frame` for more info).</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><a href="#__codelineno-0-136"><span class="linenos" data-linenos="136 "></span></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><a href="#__codelineno-0-137"><span class="linenos" data-linenos="137 "></span></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><a href="#__codelineno-0-138"><span class="linenos" data-linenos="138 "></span></a><span class="sd">            frames: A list of Frames populated with pred_track_ids and asso_matrices</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><a href="#__codelineno-0-139"><span class="linenos" data-linenos="139 "></span></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><a href="#__codelineno-0-140"><span class="linenos" data-linenos="140 "></span></a>        <span class="c1"># all batches up until context_length number of frames have been tracked, will be tracked frame-by-frame</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><a href="#__codelineno-0-141"><span class="linenos" data-linenos="141 "></span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_frames_tracked</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">:</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><a href="#__codelineno-0-142"><span class="linenos" data-linenos="142 "></span></a>            <span class="n">frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_by_frame</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">frames</span><span class="p">)</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><a href="#__codelineno-0-143"><span class="linenos" data-linenos="143 "></span></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><a href="#__codelineno-0-144"><span class="linenos" data-linenos="144 "></span></a>            <span class="n">frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_by_batch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">frames</span><span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><a href="#__codelineno-0-145"><span class="linenos" data-linenos="145 "></span></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><a href="#__codelineno-0-146"><span class="linenos" data-linenos="146 "></span></a>        <span class="k">return</span> <span class="n">frames</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><a href="#__codelineno-0-147"><span class="linenos" data-linenos="147 "></span></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><a href="#__codelineno-0-148"><span class="linenos" data-linenos="148 "></span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">track_by_batch</span><span class="p">(</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><a href="#__codelineno-0-149"><span class="linenos" data-linenos="149 "></span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">GlobalTrackingTransformer</span><span class="p">,</span> <span class="n">frames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Frame</span><span class="p">]</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><a href="#__codelineno-0-150"><span class="linenos" data-linenos="150 "></span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Frame</span><span class="p">]:</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><a href="#__codelineno-0-151"><span class="linenos" data-linenos="151 "></span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform sliding inference, on an entire batch of frames, on the input video (instances) with a given context length (window size).</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><a href="#__codelineno-0-152"><span class="linenos" data-linenos="152 "></span></a>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><a href="#__codelineno-0-153"><span class="linenos" data-linenos="153 "></span></a><span class="sd">        Args:</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><a href="#__codelineno-0-154"><span class="linenos" data-linenos="154 "></span></a><span class="sd">            model: the pretrained GlobalTrackingTransformer to be used for inference</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><a href="#__codelineno-0-155"><span class="linenos" data-linenos="155 "></span></a><span class="sd">            frames: A list of Frames (See `dreem.io.Frame` for more info).</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><a href="#__codelineno-0-156"><span class="linenos" data-linenos="156 "></span></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><a href="#__codelineno-0-157"><span class="linenos" data-linenos="157 "></span></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><a href="#__codelineno-0-158"><span class="linenos" data-linenos="158 "></span></a><span class="sd">            frames: A list of Frames populated with pred_track_ids and asso_matrices</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><a href="#__codelineno-0-159"><span class="linenos" data-linenos="159 "></span></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><a href="#__codelineno-0-160"><span class="linenos" data-linenos="160 "></span></a>        <span class="c1"># context window starts from last frame just before start of current batch, to window_size frames preceding it</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><a href="#__codelineno-0-161"><span class="linenos" data-linenos="161 "></span></a>        <span class="c1"># note; can&#39;t use last frame of previous batch, because there could be empty frames in between batches that must</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><a href="#__codelineno-0-162"><span class="linenos" data-linenos="162 "></span></a>        <span class="c1"># be part of the context window for consistency</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><a href="#__codelineno-0-163"><span class="linenos" data-linenos="163 "></span></a>        <span class="n">context_window_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span><span class="o">.</span><span class="n">collate_tracks</span><span class="p">(</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><a href="#__codelineno-0-164"><span class="linenos" data-linenos="164 "></span></a>            <span class="n">context_start_frame_id</span><span class="o">=</span><span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">frame_id</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><a href="#__codelineno-0-165"><span class="linenos" data-linenos="165 "></span></a>            <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># switched off in collate_tracks; there is no cutoff for context, only until the deque gets filled</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><a href="#__codelineno-0-166"><span class="linenos" data-linenos="166 "></span></a>            <span class="n">device</span><span class="o">=</span><span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">frame_id</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><a href="#__codelineno-0-167"><span class="linenos" data-linenos="167 "></span></a>        <span class="p">)</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><a href="#__codelineno-0-168"><span class="linenos" data-linenos="168 "></span></a>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><a href="#__codelineno-0-169"><span class="linenos" data-linenos="169 "></span></a>        <span class="n">context_window_instances</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><a href="#__codelineno-0-170"><span class="linenos" data-linenos="170 "></span></a>        <span class="n">context_window_instance_frame_ids</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><a href="#__codelineno-0-171"><span class="linenos" data-linenos="171 "></span></a>        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">context_window_frames</span><span class="p">:</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><a href="#__codelineno-0-172"><span class="linenos" data-linenos="172 "></span></a>            <span class="n">context_window_instances</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">instances</span><span class="p">)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><a href="#__codelineno-0-173"><span class="linenos" data-linenos="173 "></span></a>            <span class="n">context_window_instance_frame_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><a href="#__codelineno-0-174"><span class="linenos" data-linenos="174 "></span></a>                <span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">frame_id</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">instances</span><span class="p">)</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><a href="#__codelineno-0-175"><span class="linenos" data-linenos="175 "></span></a>            <span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><a href="#__codelineno-0-176"><span class="linenos" data-linenos="176 "></span></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><a href="#__codelineno-0-177"><span class="linenos" data-linenos="177 "></span></a>        <span class="n">current_batch_instances</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><a href="#__codelineno-0-178"><span class="linenos" data-linenos="178 "></span></a>        <span class="n">current_batch_instance_frame_ids</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><a href="#__codelineno-0-179"><span class="linenos" data-linenos="179 "></span></a>        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><a href="#__codelineno-0-180"><span class="linenos" data-linenos="180 "></span></a>            <span class="n">current_batch_instances</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">instances</span><span class="p">)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><a href="#__codelineno-0-181"><span class="linenos" data-linenos="181 "></span></a>            <span class="n">current_batch_instance_frame_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><a href="#__codelineno-0-182"><span class="linenos" data-linenos="182 "></span></a>                <span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">frame_id</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">instances</span><span class="p">)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><a href="#__codelineno-0-183"><span class="linenos" data-linenos="183 "></span></a>            <span class="p">)</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a><a href="#__codelineno-0-184"><span class="linenos" data-linenos="184 "></span></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><a href="#__codelineno-0-185"><span class="linenos" data-linenos="185 "></span></a>        <span class="n">frames_to_track</span> <span class="o">=</span> <span class="n">context_window_frames</span> <span class="o">+</span> <span class="n">frames</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a><a href="#__codelineno-0-186"><span class="linenos" data-linenos="186 "></span></a>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a><a href="#__codelineno-0-187"><span class="linenos" data-linenos="187 "></span></a>        <span class="c1"># query is current batch instances, key is context window and current batch instances</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a><a href="#__codelineno-0-188"><span class="linenos" data-linenos="188 "></span></a>        <span class="n">association_matrix</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a><a href="#__codelineno-0-189"><span class="linenos" data-linenos="189 "></span></a>            <span class="n">context_window_instances</span> <span class="o">+</span> <span class="n">current_batch_instances</span><span class="p">,</span> <span class="n">current_batch_instances</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a><a href="#__codelineno-0-190"><span class="linenos" data-linenos="190 "></span></a>        <span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a><a href="#__codelineno-0-191"><span class="linenos" data-linenos="191 "></span></a>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><a href="#__codelineno-0-192"><span class="linenos" data-linenos="192 "></span></a>        <span class="c1"># take association matrix and all frames off GPU (frames include instances)</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><a href="#__codelineno-0-193"><span class="linenos" data-linenos="193 "></span></a>        <span class="n">association_matrix</span> <span class="o">=</span> <span class="n">association_matrix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a><a href="#__codelineno-0-194"><span class="linenos" data-linenos="194 "></span></a>        <span class="n">context_window_frames</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">context_window_frames</span><span class="p">]</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><a href="#__codelineno-0-195"><span class="linenos" data-linenos="195 "></span></a>        <span class="n">frames</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">]</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a><a href="#__codelineno-0-196"><span class="linenos" data-linenos="196 "></span></a>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a><a href="#__codelineno-0-197"><span class="linenos" data-linenos="197 "></span></a>        <span class="c1"># keep current batch instances in assoc matrix, and remove them after softmax (mirrors the training scheme)</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><a href="#__codelineno-0-198"><span class="linenos" data-linenos="198 "></span></a>        <span class="n">pred_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_batch_tracker</span><span class="p">(</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a><a href="#__codelineno-0-199"><span class="linenos" data-linenos="199 "></span></a>            <span class="n">association_matrix</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a><a href="#__codelineno-0-200"><span class="linenos" data-linenos="200 "></span></a>            <span class="n">context_window_frames</span><span class="p">,</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a><a href="#__codelineno-0-201"><span class="linenos" data-linenos="201 "></span></a>            <span class="n">frames</span><span class="p">,</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a><a href="#__codelineno-0-202"><span class="linenos" data-linenos="202 "></span></a>            <span class="n">compute_probs_by_frame</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><a href="#__codelineno-0-203"><span class="linenos" data-linenos="203 "></span></a>        <span class="p">)</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><a href="#__codelineno-0-204"><span class="linenos" data-linenos="204 "></span></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><a href="#__codelineno-0-205"><span class="linenos" data-linenos="205 "></span></a>        <span class="k">return</span> <span class="n">pred_frames</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><a href="#__codelineno-0-206"><span class="linenos" data-linenos="206 "></span></a>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><a href="#__codelineno-0-207"><span class="linenos" data-linenos="207 "></span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">track_by_frame</span><span class="p">(</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><a href="#__codelineno-0-208"><span class="linenos" data-linenos="208 "></span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">GlobalTrackingTransformer</span><span class="p">,</span> <span class="n">frames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Frame</span><span class="p">]</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><a href="#__codelineno-0-209"><span class="linenos" data-linenos="209 "></span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Frame</span><span class="p">]:</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><a href="#__codelineno-0-210"><span class="linenos" data-linenos="210 "></span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform sliding inference on the input video (instances) with a given window size.</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><a href="#__codelineno-0-211"><span class="linenos" data-linenos="211 "></span></a>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><a href="#__codelineno-0-212"><span class="linenos" data-linenos="212 "></span></a><span class="sd">        Args:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a><a href="#__codelineno-0-213"><span class="linenos" data-linenos="213 "></span></a><span class="sd">            model: the pretrained GlobalTrackingTransformer to be used for inference</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a><a href="#__codelineno-0-214"><span class="linenos" data-linenos="214 "></span></a><span class="sd">            frames: A list of Frames (See `dreem.io.Frame` for more info).</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a><a href="#__codelineno-0-215"><span class="linenos" data-linenos="215 "></span></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><a href="#__codelineno-0-216"><span class="linenos" data-linenos="216 "></span></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a><a href="#__codelineno-0-217"><span class="linenos" data-linenos="217 "></span></a><span class="sd">            frames: A list of Frames populated with pred_track_ids and asso_matrices</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><a href="#__codelineno-0-218"><span class="linenos" data-linenos="218 "></span></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><a href="#__codelineno-0-219"><span class="linenos" data-linenos="219 "></span></a>        <span class="c1"># B: batch size.</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><a href="#__codelineno-0-220"><span class="linenos" data-linenos="220 "></span></a>        <span class="c1"># D: embedding dimension.</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><a href="#__codelineno-0-221"><span class="linenos" data-linenos="221 "></span></a>        <span class="c1"># nc: number of channels.</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><a href="#__codelineno-0-222"><span class="linenos" data-linenos="222 "></span></a>        <span class="c1"># H: height.</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><a href="#__codelineno-0-223"><span class="linenos" data-linenos="223 "></span></a>        <span class="c1"># W: width.</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a><a href="#__codelineno-0-224"><span class="linenos" data-linenos="224 "></span></a>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a><a href="#__codelineno-0-225"><span class="linenos" data-linenos="225 "></span></a>        <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">frame_to_track</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frames</span><span class="p">):</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><a href="#__codelineno-0-226"><span class="linenos" data-linenos="226 "></span></a>            <span class="c1"># if we&#39;re tracking by frame, it means context length of frames hasn&#39;t been reached yet, so context start frame id is 0</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a><a href="#__codelineno-0-227"><span class="linenos" data-linenos="227 "></span></a>            <span class="n">context_window_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span><span class="o">.</span><span class="n">collate_tracks</span><span class="p">(</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a><a href="#__codelineno-0-228"><span class="linenos" data-linenos="228 "></span></a>                <span class="n">context_start_frame_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">frame_to_track</span><span class="o">.</span><span class="n">frame_id</span><span class="o">.</span><span class="n">device</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a><a href="#__codelineno-0-229"><span class="linenos" data-linenos="229 "></span></a>            <span class="p">)</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a><a href="#__codelineno-0-230"><span class="linenos" data-linenos="230 "></span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current number of tracks is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span><span class="o">.</span><span class="n">n_tracks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a><a href="#__codelineno-0-231"><span class="linenos" data-linenos="231 "></span></a>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a><a href="#__codelineno-0-232"><span class="linenos" data-linenos="232 "></span></a>            <span class="k">if</span> <span class="p">(</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a><a href="#__codelineno-0-233"><span class="linenos" data-linenos="233 "></span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">persistent_tracking</span> <span class="ow">and</span> <span class="n">frame_to_track</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">==</span> <span class="mi">0</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a><a href="#__codelineno-0-234"><span class="linenos" data-linenos="234 "></span></a>            <span class="p">):</span>  <span class="c1"># check for new video and clear queue</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a><a href="#__codelineno-0-235"><span class="linenos" data-linenos="235 "></span></a>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a><a href="#__codelineno-0-236"><span class="linenos" data-linenos="236 "></span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;New Video! Resetting Track Queue.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a><a href="#__codelineno-0-237"><span class="linenos" data-linenos="237 "></span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span><span class="o">.</span><span class="n">end_tracks</span><span class="p">()</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a><a href="#__codelineno-0-238"><span class="linenos" data-linenos="238 "></span></a>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><a href="#__codelineno-0-239"><span class="linenos" data-linenos="239 "></span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><a href="#__codelineno-0-240"><span class="linenos" data-linenos="240 "></span></a><span class="sd">            Initialize tracks on first frame where detections appear. This is the first frame of the first batch</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a><a href="#__codelineno-0-241"><span class="linenos" data-linenos="241 "></span></a><span class="sd">            &quot;&quot;&quot;</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><a href="#__codelineno-0-242"><span class="linenos" data-linenos="242 "></span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><a href="#__codelineno-0-243"><span class="linenos" data-linenos="243 "></span></a>                <span class="k">if</span> <span class="n">frame_to_track</span><span class="o">.</span><span class="n">has_instances</span><span class="p">():</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><a href="#__codelineno-0-244"><span class="linenos" data-linenos="244 "></span></a>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><a href="#__codelineno-0-245"><span class="linenos" data-linenos="245 "></span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><a href="#__codelineno-0-246"><span class="linenos" data-linenos="246 "></span></a>                        <span class="sa">f</span><span class="s2">&quot;Initializing track on clip ind </span><span class="si">{</span><span class="n">batch_idx</span><span class="si">}</span><span class="s2"> frame </span><span class="si">{</span><span class="n">frame_to_track</span><span class="o">.</span><span class="n">frame_id</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a><a href="#__codelineno-0-247"><span class="linenos" data-linenos="247 "></span></a>                    <span class="p">)</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><a href="#__codelineno-0-248"><span class="linenos" data-linenos="248 "></span></a>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><a href="#__codelineno-0-249"><span class="linenos" data-linenos="249 "></span></a>                    <span class="n">curr_track_id</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><a href="#__codelineno-0-250"><span class="linenos" data-linenos="250 "></span></a>                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">instance</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">]</span><span class="o">.</span><span class="n">instances</span><span class="p">):</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><a href="#__codelineno-0-251"><span class="linenos" data-linenos="251 "></span></a>                        <span class="n">instance</span><span class="o">.</span><span class="n">pred_track_id</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">gt_track_id</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><a href="#__codelineno-0-252"><span class="linenos" data-linenos="252 "></span></a>                        <span class="n">curr_track_id</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_track_id</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">pred_track_id</span><span class="p">)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><a href="#__codelineno-0-253"><span class="linenos" data-linenos="253 "></span></a>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><a href="#__codelineno-0-254"><span class="linenos" data-linenos="254 "></span></a>                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">instance</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">]</span><span class="o">.</span><span class="n">instances</span><span class="p">):</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><a href="#__codelineno-0-255"><span class="linenos" data-linenos="255 "></span></a>                        <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">pred_track_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><a href="#__codelineno-0-256"><span class="linenos" data-linenos="256 "></span></a>                            <span class="n">curr_track_id</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><a href="#__codelineno-0-257"><span class="linenos" data-linenos="257 "></span></a>                            <span class="n">instance</span><span class="o">.</span><span class="n">pred_track_id</span> <span class="o">=</span> <span class="n">curr_track_id</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><a href="#__codelineno-0-258"><span class="linenos" data-linenos="258 "></span></a>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><a href="#__codelineno-0-259"><span class="linenos" data-linenos="259 "></span></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><a href="#__codelineno-0-260"><span class="linenos" data-linenos="260 "></span></a>                <span class="k">if</span> <span class="p">(</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><a href="#__codelineno-0-261"><span class="linenos" data-linenos="261 "></span></a>                    <span class="n">frame_to_track</span><span class="o">.</span><span class="n">has_instances</span><span class="p">()</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><a href="#__codelineno-0-262"><span class="linenos" data-linenos="262 "></span></a>                <span class="p">):</span>  <span class="c1"># Check if there are detections. If there are skip and increment gap count</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a><a href="#__codelineno-0-263"><span class="linenos" data-linenos="263 "></span></a>                    <span class="n">frames_to_track</span> <span class="o">=</span> <span class="n">context_window_frames</span> <span class="o">+</span> <span class="p">[</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><a href="#__codelineno-0-264"><span class="linenos" data-linenos="264 "></span></a>                        <span class="n">frame_to_track</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><a href="#__codelineno-0-265"><span class="linenos" data-linenos="265 "></span></a>                    <span class="p">]</span>  <span class="c1"># better var name?</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><a href="#__codelineno-0-266"><span class="linenos" data-linenos="266 "></span></a>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><a href="#__codelineno-0-267"><span class="linenos" data-linenos="267 "></span></a>                    <span class="n">query_ind</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames_to_track</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><a href="#__codelineno-0-268"><span class="linenos" data-linenos="268 "></span></a>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a><a href="#__codelineno-0-269"><span class="linenos" data-linenos="269 "></span></a>                    <span class="n">frame_to_track</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_frame_by_frame_tracker</span><span class="p">(</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><a href="#__codelineno-0-270"><span class="linenos" data-linenos="270 "></span></a>                        <span class="n">model</span><span class="p">,</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a><a href="#__codelineno-0-271"><span class="linenos" data-linenos="271 "></span></a>                        <span class="n">frames_to_track</span><span class="p">,</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a><a href="#__codelineno-0-272"><span class="linenos" data-linenos="272 "></span></a>                    <span class="p">)</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a><a href="#__codelineno-0-273"><span class="linenos" data-linenos="273 "></span></a>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a><a href="#__codelineno-0-274"><span class="linenos" data-linenos="274 "></span></a>            <span class="k">if</span> <span class="n">frame_to_track</span><span class="o">.</span><span class="n">has_instances</span><span class="p">():</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a><a href="#__codelineno-0-275"><span class="linenos" data-linenos="275 "></span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span><span class="o">.</span><span class="n">add_frame</span><span class="p">(</span><span class="n">frame_to_track</span><span class="p">)</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a><a href="#__codelineno-0-276"><span class="linenos" data-linenos="276 "></span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">num_frames_tracked</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a><a href="#__codelineno-0-277"><span class="linenos" data-linenos="277 "></span></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a><a href="#__codelineno-0-278"><span class="linenos" data-linenos="278 "></span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span><span class="o">.</span><span class="n">increment_gaps</span><span class="p">([])</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><a href="#__codelineno-0-279"><span class="linenos" data-linenos="279 "></span></a>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a><a href="#__codelineno-0-280"><span class="linenos" data-linenos="280 "></span></a>            <span class="n">frames</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame_to_track</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a><a href="#__codelineno-0-281"><span class="linenos" data-linenos="281 "></span></a>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a><a href="#__codelineno-0-282"><span class="linenos" data-linenos="282 "></span></a>        <span class="k">return</span> <span class="n">frames</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><a href="#__codelineno-0-283"><span class="linenos" data-linenos="283 "></span></a>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><a href="#__codelineno-0-284"><span class="linenos" data-linenos="284 "></span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_run_batch_tracker</span><span class="p">(</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><a href="#__codelineno-0-285"><span class="linenos" data-linenos="285 "></span></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a><a href="#__codelineno-0-286"><span class="linenos" data-linenos="286 "></span></a>        <span class="n">association_matrix</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><a href="#__codelineno-0-287"><span class="linenos" data-linenos="287 "></span></a>        <span class="n">context_window_frames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Frame</span><span class="p">],</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><a href="#__codelineno-0-288"><span class="linenos" data-linenos="288 "></span></a>        <span class="n">frames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Frame</span><span class="p">],</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a><a href="#__codelineno-0-289"><span class="linenos" data-linenos="289 "></span></a>        <span class="n">compute_probs_by_frame</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a><a href="#__codelineno-0-290"><span class="linenos" data-linenos="290 "></span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Frame</span><span class="p">:</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><a href="#__codelineno-0-291"><span class="linenos" data-linenos="291 "></span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run batch tracker performs track assignment for each frame in the current batch.</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a><a href="#__codelineno-0-292"><span class="linenos" data-linenos="292 "></span></a>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a><a href="#__codelineno-0-293"><span class="linenos" data-linenos="293 "></span></a><span class="sd">        Supports 2 methods for computing association probabilities. First is to softmax each query instance in each query frame in the batch, with only 1 frame at a time from the context window.</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a><a href="#__codelineno-0-294"><span class="linenos" data-linenos="294 "></span></a><span class="sd">        This is the default method and only supports local track linking.</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><a href="#__codelineno-0-295"><span class="linenos" data-linenos="295 "></span></a><span class="sd">        Second is to softmax the entire context + curr batch, then index. This enables global track linking via e.g. ILP. In this case, prob values will be smaller and the overlap thresh should be decreased</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><a href="#__codelineno-0-296"><span class="linenos" data-linenos="296 "></span></a>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><a href="#__codelineno-0-297"><span class="linenos" data-linenos="297 "></span></a><span class="sd">        Args:</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a><a href="#__codelineno-0-298"><span class="linenos" data-linenos="298 "></span></a><span class="sd">            association_matrix: the association matrix to be used for tracking</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a><a href="#__codelineno-0-299"><span class="linenos" data-linenos="299 "></span></a><span class="sd">            context_window_frames: list of frames in the context window</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a><a href="#__codelineno-0-300"><span class="linenos" data-linenos="300 "></span></a><span class="sd">            frames: list of frames in the current batch</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a><a href="#__codelineno-0-301"><span class="linenos" data-linenos="301 "></span></a><span class="sd">            compute_probs_by_frame: Whether to softmax the association matrix logits for each frame in context separately, or globally for the entire context window + current batch</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a><a href="#__codelineno-0-302"><span class="linenos" data-linenos="302 "></span></a>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><a href="#__codelineno-0-303"><span class="linenos" data-linenos="303 "></span></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><a href="#__codelineno-0-304"><span class="linenos" data-linenos="304 "></span></a><span class="sd">            List of frames populated with pred_track_ids and asso_matrices</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a><a href="#__codelineno-0-305"><span class="linenos" data-linenos="305 "></span></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a><a href="#__codelineno-0-306"><span class="linenos" data-linenos="306 "></span></a>        <span class="n">tracked_frames</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a><a href="#__codelineno-0-307"><span class="linenos" data-linenos="307 "></span></a>        <span class="n">num_instances_per_frame</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a><a href="#__codelineno-0-308"><span class="linenos" data-linenos="308 "></span></a>            <span class="n">frame</span><span class="o">.</span><span class="n">num_detected</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">context_window_frames</span> <span class="o">+</span> <span class="n">frames</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a><a href="#__codelineno-0-309"><span class="linenos" data-linenos="309 "></span></a>        <span class="p">]</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a><a href="#__codelineno-0-310"><span class="linenos" data-linenos="310 "></span></a>        <span class="n">all_frames</span> <span class="o">=</span> <span class="n">context_window_frames</span> <span class="o">+</span> <span class="n">frames</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a><a href="#__codelineno-0-311"><span class="linenos" data-linenos="311 "></span></a>        <span class="n">batch_start_ind</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">num_instances_per_frame</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a><a href="#__codelineno-0-312"><span class="linenos" data-linenos="312 "></span></a>        <span class="n">overlap_thresh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap_thresh</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a><a href="#__codelineno-0-313"><span class="linenos" data-linenos="313 "></span></a>        <span class="n">mult_thresh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_thresh</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a><a href="#__codelineno-0-314"><span class="linenos" data-linenos="314 "></span></a>        <span class="n">n_traj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span><span class="o">.</span><span class="n">n_tracks</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a><a href="#__codelineno-0-315"><span class="linenos" data-linenos="315 "></span></a>        <span class="n">curr_track</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span><span class="o">.</span><span class="n">curr_track</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a><a href="#__codelineno-0-316"><span class="linenos" data-linenos="316 "></span></a>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a><a href="#__codelineno-0-317"><span class="linenos" data-linenos="317 "></span></a>        <span class="k">for</span> <span class="n">query_frame_idx</span><span class="p">,</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a><a href="#__codelineno-0-318"><span class="linenos" data-linenos="318 "></span></a>            <span class="n">frames</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a><a href="#__codelineno-0-319"><span class="linenos" data-linenos="319 "></span></a>        <span class="p">):</span>  <span class="c1"># only track frames in current batch, not in context window</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a><a href="#__codelineno-0-320"><span class="linenos" data-linenos="320 "></span></a>            <span class="n">all_prev_instances</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a><a href="#__codelineno-0-321"><span class="linenos" data-linenos="321 "></span></a>                <span class="n">instance</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a><a href="#__codelineno-0-322"><span class="linenos" data-linenos="322 "></span></a>                <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">context_window_frames</span> <span class="o">+</span> <span class="n">frames</span><span class="p">[:</span><span class="n">query_frame_idx</span><span class="p">]</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a><a href="#__codelineno-0-323"><span class="linenos" data-linenos="323 "></span></a>                <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">instances</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a><a href="#__codelineno-0-324"><span class="linenos" data-linenos="324 "></span></a>            <span class="p">]</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a><a href="#__codelineno-0-325"><span class="linenos" data-linenos="325 "></span></a>            <span class="c1"># indices that will be used to index the rows of the association matrix corresponding to the query frame instances</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a><a href="#__codelineno-0-326"><span class="linenos" data-linenos="326 "></span></a>            <span class="n">query_inds</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a><a href="#__codelineno-0-327"><span class="linenos" data-linenos="327 "></span></a>                <span class="n">x</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a><a href="#__codelineno-0-328"><span class="linenos" data-linenos="328 "></span></a>                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a><a href="#__codelineno-0-329"><span class="linenos" data-linenos="329 "></span></a>                    <span class="nb">sum</span><span class="p">(</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a><a href="#__codelineno-0-330"><span class="linenos" data-linenos="330 "></span></a>                        <span class="n">num_instances_per_frame</span><span class="p">[</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a><a href="#__codelineno-0-331"><span class="linenos" data-linenos="331 "></span></a>                            <span class="n">batch_start_ind</span> <span class="p">:</span> <span class="n">batch_start_ind</span> <span class="o">+</span> <span class="n">query_frame_idx</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a><a href="#__codelineno-0-332"><span class="linenos" data-linenos="332 "></span></a>                        <span class="p">]</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a><a href="#__codelineno-0-333"><span class="linenos" data-linenos="333 "></span></a>                    <span class="p">),</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a><a href="#__codelineno-0-334"><span class="linenos" data-linenos="334 "></span></a>                    <span class="nb">sum</span><span class="p">(</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a><a href="#__codelineno-0-335"><span class="linenos" data-linenos="335 "></span></a>                        <span class="n">num_instances_per_frame</span><span class="p">[</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a><a href="#__codelineno-0-336"><span class="linenos" data-linenos="336 "></span></a>                            <span class="n">batch_start_ind</span> <span class="p">:</span> <span class="n">batch_start_ind</span> <span class="o">+</span> <span class="n">query_frame_idx</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a><a href="#__codelineno-0-337"><span class="linenos" data-linenos="337 "></span></a>                        <span class="p">]</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a><a href="#__codelineno-0-338"><span class="linenos" data-linenos="338 "></span></a>                    <span class="p">),</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a><a href="#__codelineno-0-339"><span class="linenos" data-linenos="339 "></span></a>                <span class="p">)</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a><a href="#__codelineno-0-340"><span class="linenos" data-linenos="340 "></span></a>            <span class="p">]</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a><a href="#__codelineno-0-341"><span class="linenos" data-linenos="341 "></span></a>            <span class="c1"># first, slice the association matrix to only include the query frame instances along the rows; these are the &#39;detections&#39; to be matched to tracks</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a><a href="#__codelineno-0-342"><span class="linenos" data-linenos="342 "></span></a>            <span class="c1"># recall incoming association_matrix is (num_instances_in_batch, num_instances_in_context_window + num_instances_in_batch)</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a><a href="#__codelineno-0-343"><span class="linenos" data-linenos="343 "></span></a>            <span class="n">assoc_curr_frame</span> <span class="o">=</span> <span class="n">association_matrix</span><span class="p">[</span><span class="n">query_inds</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a><a href="#__codelineno-0-344"><span class="linenos" data-linenos="344 "></span></a>            <span class="c1"># discard the columns (ref instances) corresponding to frames including and after the current frame; this means each frame will see previous frames in the batch as well as the context window when linking to tracks</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a><a href="#__codelineno-0-345"><span class="linenos" data-linenos="345 "></span></a>            <span class="c1"># importantly, this means that tracks will be aggregated over a much longer time period than the context window size, making many more tracks visible to each frame to link detections to</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a><a href="#__codelineno-0-346"><span class="linenos" data-linenos="346 "></span></a>            <span class="n">assoc_curr_frame_by_previous_frames</span> <span class="o">=</span> <span class="n">assoc_curr_frame</span><span class="p">[</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a><a href="#__codelineno-0-347"><span class="linenos" data-linenos="347 "></span></a>                <span class="p">:,</span> <span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">num_instances_per_frame</span><span class="p">[:</span> <span class="n">batch_start_ind</span> <span class="o">+</span> <span class="n">query_frame_idx</span><span class="p">])</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a><a href="#__codelineno-0-348"><span class="linenos" data-linenos="348 "></span></a>            <span class="p">]</span>  <span class="c1"># (num_query_instances, num instances in context window + num instances in current batch up till current frame)</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a><a href="#__codelineno-0-349"><span class="linenos" data-linenos="349 "></span></a>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a><a href="#__codelineno-0-350"><span class="linenos" data-linenos="350 "></span></a>            <span class="c1"># method 1</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a><a href="#__codelineno-0-351"><span class="linenos" data-linenos="351 "></span></a>            <span class="k">if</span> <span class="n">compute_probs_by_frame</span><span class="p">:</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a><a href="#__codelineno-0-352"><span class="linenos" data-linenos="352 "></span></a>                <span class="c1"># for each frame in the context window, split the assoc matrix columns by frame</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a><a href="#__codelineno-0-353"><span class="linenos" data-linenos="353 "></span></a>                <span class="n">split_assos</span> <span class="o">=</span> <span class="n">assoc_curr_frame_by_previous_frames</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a><a href="#__codelineno-0-354"><span class="linenos" data-linenos="354 "></span></a>                    <span class="n">num_instances_per_frame</span><span class="p">[:</span> <span class="n">batch_start_ind</span> <span class="o">+</span> <span class="n">query_frame_idx</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a><a href="#__codelineno-0-355"><span class="linenos" data-linenos="355 "></span></a>                <span class="p">)</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a><a href="#__codelineno-0-356"><span class="linenos" data-linenos="356 "></span></a>                <span class="c1"># compute softmax per-frame</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a><a href="#__codelineno-0-357"><span class="linenos" data-linenos="357 "></span></a>                <span class="n">softmaxed_asso</span> <span class="o">=</span> <span class="n">model_utils</span><span class="o">.</span><span class="n">softmax_asso</span><span class="p">(</span><span class="n">split_assos</span><span class="p">)</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a><a href="#__codelineno-0-358"><span class="linenos" data-linenos="358 "></span></a>                <span class="c1"># merge the softmaxed assoc matrices back together to get (num_query_instances, num_instances_in_context_window)</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a><a href="#__codelineno-0-359"><span class="linenos" data-linenos="359 "></span></a>                <span class="n">softmaxed_asso</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">softmaxed_asso</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a><a href="#__codelineno-0-360"><span class="linenos" data-linenos="360 "></span></a>            <span class="c1"># method 2</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a><a href="#__codelineno-0-361"><span class="linenos" data-linenos="361 "></span></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><a href="#__codelineno-0-362"><span class="linenos" data-linenos="362 "></span></a>                <span class="c1"># compute softmax across the entire context window and current batch frames</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a><a href="#__codelineno-0-363"><span class="linenos" data-linenos="363 "></span></a>                <span class="n">softmaxed_asso</span> <span class="o">=</span> <span class="n">model_utils</span><span class="o">.</span><span class="n">softmax_asso</span><span class="p">(</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a><a href="#__codelineno-0-364"><span class="linenos" data-linenos="364 "></span></a>                    <span class="n">assoc_curr_frame_by_previous_frames</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a><a href="#__codelineno-0-365"><span class="linenos" data-linenos="365 "></span></a>                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a><a href="#__codelineno-0-366"><span class="linenos" data-linenos="366 "></span></a>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a><a href="#__codelineno-0-367"><span class="linenos" data-linenos="367 "></span></a>            <span class="c1"># proceed with post processing, LSA, and track assignment (duplicated code with frame by frame tracker)</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a><a href="#__codelineno-0-368"><span class="linenos" data-linenos="368 "></span></a>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a><a href="#__codelineno-0-369"><span class="linenos" data-linenos="369 "></span></a>            <span class="c1"># get raw bbox coords of prev frame instances from frame.instances_per_frame</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a><a href="#__codelineno-0-370"><span class="linenos" data-linenos="370 "></span></a>            <span class="n">prev_frame</span> <span class="o">=</span> <span class="n">all_frames</span><span class="p">[</span><span class="n">batch_start_ind</span> <span class="o">+</span> <span class="n">query_frame_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a><a href="#__codelineno-0-371"><span class="linenos" data-linenos="371 "></span></a>            <span class="n">prev_frame_instance_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a><a href="#__codelineno-0-372"><span class="linenos" data-linenos="372 "></span></a>                <span class="p">[</span><span class="n">instance</span><span class="o">.</span><span class="n">pred_track_id</span> <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">prev_frame</span><span class="o">.</span><span class="n">instances</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a><a href="#__codelineno-0-373"><span class="linenos" data-linenos="373 "></span></a>            <span class="p">)</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a><a href="#__codelineno-0-374"><span class="linenos" data-linenos="374 "></span></a>            <span class="n">prev_frame_boxes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a><a href="#__codelineno-0-375"><span class="linenos" data-linenos="375 "></span></a>                <span class="p">[</span><span class="n">instance</span><span class="o">.</span><span class="n">bbox</span> <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">prev_frame</span><span class="o">.</span><span class="n">instances</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a><a href="#__codelineno-0-376"><span class="linenos" data-linenos="376 "></span></a>            <span class="p">)</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a><a href="#__codelineno-0-377"><span class="linenos" data-linenos="377 "></span></a>            <span class="n">all_prev_frames_boxes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a><a href="#__codelineno-0-378"><span class="linenos" data-linenos="378 "></span></a>                <span class="p">[</span><span class="n">instance</span><span class="o">.</span><span class="n">bbox</span> <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">all_prev_instances</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a><a href="#__codelineno-0-379"><span class="linenos" data-linenos="379 "></span></a>            <span class="p">)</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a><a href="#__codelineno-0-380"><span class="linenos" data-linenos="380 "></span></a>            <span class="n">curr_frame_boxes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a><a href="#__codelineno-0-381"><span class="linenos" data-linenos="381 "></span></a>                <span class="p">[</span><span class="n">instance</span><span class="o">.</span><span class="n">bbox</span> <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">instances</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a><a href="#__codelineno-0-382"><span class="linenos" data-linenos="382 "></span></a>            <span class="p">)</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a><a href="#__codelineno-0-383"><span class="linenos" data-linenos="383 "></span></a>            <span class="c1"># get the pred track ids for all instances up until the current frame</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a><a href="#__codelineno-0-384"><span class="linenos" data-linenos="384 "></span></a>            <span class="n">instance_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a><a href="#__codelineno-0-385"><span class="linenos" data-linenos="385 "></span></a>                <span class="p">[</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a><a href="#__codelineno-0-386"><span class="linenos" data-linenos="386 "></span></a>                    <span class="n">x</span><span class="o">.</span><span class="n">get_pred_track_ids</span><span class="p">()</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><a href="#__codelineno-0-387"><span class="linenos" data-linenos="387 "></span></a>                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">all_frames</span><span class="p">[:</span> <span class="n">batch_start_ind</span> <span class="o">+</span> <span class="n">query_frame_idx</span><span class="p">]</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a><a href="#__codelineno-0-388"><span class="linenos" data-linenos="388 "></span></a>                <span class="p">],</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a><a href="#__codelineno-0-389"><span class="linenos" data-linenos="389 "></span></a>                <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a><a href="#__codelineno-0-390"><span class="linenos" data-linenos="390 "></span></a>            <span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a><a href="#__codelineno-0-391"><span class="linenos" data-linenos="391 "></span></a>                <span class="nb">sum</span><span class="p">(</span><span class="n">num_instances_per_frame</span><span class="p">[:</span> <span class="n">batch_start_ind</span> <span class="o">+</span> <span class="n">query_frame_idx</span><span class="p">])</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a><a href="#__codelineno-0-392"><span class="linenos" data-linenos="392 "></span></a>            <span class="p">)</span>  <span class="c1"># (n_nonquery,)</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a><a href="#__codelineno-0-393"><span class="linenos" data-linenos="393 "></span></a>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a><a href="#__codelineno-0-394"><span class="linenos" data-linenos="394 "></span></a>            <span class="n">unique_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">instance_ids</span><span class="p">)</span>  <span class="c1"># (n_nonquery,)</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a><a href="#__codelineno-0-395"><span class="linenos" data-linenos="395 "></span></a>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a><a href="#__codelineno-0-396"><span class="linenos" data-linenos="396 "></span></a>            <span class="n">_</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">img_shape</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a><a href="#__codelineno-0-397"><span class="linenos" data-linenos="397 "></span></a>            <span class="n">bbox_scaler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">])</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a><a href="#__codelineno-0-398"><span class="linenos" data-linenos="398 "></span></a>            <span class="n">query_boxes</span> <span class="o">=</span> <span class="n">curr_frame_boxes</span> <span class="o">/</span> <span class="n">bbox_scaler</span>  <span class="c1"># n_k x 4</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a><a href="#__codelineno-0-399"><span class="linenos" data-linenos="399 "></span></a>            <span class="n">nonquery_boxes</span> <span class="o">=</span> <span class="n">all_prev_frames_boxes</span> <span class="o">/</span> <span class="n">bbox_scaler</span>  <span class="c1"># n_nonquery x 4</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a><a href="#__codelineno-0-400"><span class="linenos" data-linenos="400 "></span></a>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a><a href="#__codelineno-0-401"><span class="linenos" data-linenos="401 "></span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Instance IDs: </span><span class="si">{</span><span class="n">instance_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a><a href="#__codelineno-0-402"><span class="linenos" data-linenos="402 "></span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unique ids: </span><span class="si">{</span><span class="n">unique_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a><a href="#__codelineno-0-403"><span class="linenos" data-linenos="403 "></span></a>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a><a href="#__codelineno-0-404"><span class="linenos" data-linenos="404 "></span></a>            <span class="n">id_inds</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a><a href="#__codelineno-0-405"><span class="linenos" data-linenos="405 "></span></a>                <span class="n">unique_ids</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">instance_ids</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a><a href="#__codelineno-0-406"><span class="linenos" data-linenos="406 "></span></a>            <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>  <span class="c1"># (n_nonquery, n_traj)</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a><a href="#__codelineno-0-407"><span class="linenos" data-linenos="407 "></span></a>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a><a href="#__codelineno-0-408"><span class="linenos" data-linenos="408 "></span></a>            <span class="n">prev_frame_id_inds</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a><a href="#__codelineno-0-409"><span class="linenos" data-linenos="409 "></span></a>                <span class="n">unique_ids</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">prev_frame_instance_ids</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a><a href="#__codelineno-0-410"><span class="linenos" data-linenos="410 "></span></a>            <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>  <span class="c1"># (n_prev_frame_instances, n_traj)</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a><a href="#__codelineno-0-411"><span class="linenos" data-linenos="411 "></span></a>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a><a href="#__codelineno-0-412"><span class="linenos" data-linenos="412 "></span></a>            <span class="c1"># aggregate the association matrix by tracks; output is shape (num_query_instances, num_tracks)</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a><a href="#__codelineno-0-413"><span class="linenos" data-linenos="413 "></span></a>            <span class="c1"># note the reduce operation is over the context window instances as well as current batch instances up until the current frame</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a><a href="#__codelineno-0-414"><span class="linenos" data-linenos="414 "></span></a>            <span class="c1"># (n_query x n_nonquery) x (n_nonquery x n_traj) --&gt; n_query x n_traj</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a><a href="#__codelineno-0-415"><span class="linenos" data-linenos="415 "></span></a>            <span class="n">traj_score</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">softmaxed_asso</span><span class="p">,</span> <span class="n">id_inds</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>  <span class="c1"># (n_query, n_traj)</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a><a href="#__codelineno-0-416"><span class="linenos" data-linenos="416 "></span></a>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a><a href="#__codelineno-0-417"><span class="linenos" data-linenos="417 "></span></a>            <span class="c1"># post processing</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a><a href="#__codelineno-0-418"><span class="linenos" data-linenos="418 "></span></a>            <span class="k">if</span> <span class="n">id_inds</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a><a href="#__codelineno-0-419"><span class="linenos" data-linenos="419 "></span></a>                <span class="n">last_inds</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a><a href="#__codelineno-0-420"><span class="linenos" data-linenos="420 "></span></a>                    <span class="n">id_inds</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a><a href="#__codelineno-0-421"><span class="linenos" data-linenos="421 "></span></a>                    <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_prev_instances</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">id_inds</span><span class="o">.</span><span class="n">device</span><span class="p">)[</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a><a href="#__codelineno-0-422"><span class="linenos" data-linenos="422 "></span></a>                        <span class="p">:,</span> <span class="kc">None</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a><a href="#__codelineno-0-423"><span class="linenos" data-linenos="423 "></span></a>                    <span class="p">]</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a><a href="#__codelineno-0-424"><span class="linenos" data-linenos="424 "></span></a>                <span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a><a href="#__codelineno-0-425"><span class="linenos" data-linenos="425 "></span></a>                    <span class="mi">1</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a><a href="#__codelineno-0-426"><span class="linenos" data-linenos="426 "></span></a>                <span class="p">]</span>  <span class="c1"># M</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a><a href="#__codelineno-0-427"><span class="linenos" data-linenos="427 "></span></a>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a><a href="#__codelineno-0-428"><span class="linenos" data-linenos="428 "></span></a>                <span class="n">last_boxes</span> <span class="o">=</span> <span class="n">nonquery_boxes</span><span class="p">[</span><span class="n">last_inds</span><span class="p">]</span>  <span class="c1"># n_traj x 4</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a><a href="#__codelineno-0-429"><span class="linenos" data-linenos="429 "></span></a>                <span class="n">last_ious</span> <span class="o">=</span> <span class="n">post_processing</span><span class="o">.</span><span class="n">_pairwise_iou</span><span class="p">(</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a><a href="#__codelineno-0-430"><span class="linenos" data-linenos="430 "></span></a>                    <span class="n">Boxes</span><span class="p">(</span><span class="n">query_boxes</span><span class="p">),</span> <span class="n">Boxes</span><span class="p">(</span><span class="n">last_boxes</span><span class="p">)</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a><a href="#__codelineno-0-431"><span class="linenos" data-linenos="431 "></span></a>                <span class="p">)</span>  <span class="c1"># n_k x M</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a><a href="#__codelineno-0-432"><span class="linenos" data-linenos="432 "></span></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a><a href="#__codelineno-0-433"><span class="linenos" data-linenos="433 "></span></a>                <span class="n">last_ious</span> <span class="o">=</span> <span class="n">traj_score</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="n">traj_score</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a><a href="#__codelineno-0-434"><span class="linenos" data-linenos="434 "></span></a>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a><a href="#__codelineno-0-435"><span class="linenos" data-linenos="435 "></span></a>            <span class="n">traj_score</span> <span class="o">=</span> <span class="n">post_processing</span><span class="o">.</span><span class="n">weight_iou</span><span class="p">(</span><span class="n">traj_score</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iou</span><span class="p">,</span> <span class="n">last_ious</span><span class="p">)</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a><a href="#__codelineno-0-436"><span class="linenos" data-linenos="436 "></span></a>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a><a href="#__codelineno-0-437"><span class="linenos" data-linenos="437 "></span></a>            <span class="c1"># threshold for continuing a tracking or starting a new track -&gt; they use 1.0</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a><a href="#__codelineno-0-438"><span class="linenos" data-linenos="438 "></span></a>            <span class="n">traj_score</span> <span class="o">=</span> <span class="n">post_processing</span><span class="o">.</span><span class="n">filter_max_center_dist</span><span class="p">(</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a><a href="#__codelineno-0-439"><span class="linenos" data-linenos="439 "></span></a>                <span class="n">traj_score</span><span class="p">,</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a><a href="#__codelineno-0-440"><span class="linenos" data-linenos="440 "></span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">max_center_dist</span><span class="p">,</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a><a href="#__codelineno-0-441"><span class="linenos" data-linenos="441 "></span></a>                <span class="n">prev_frame_id_inds</span><span class="p">,</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a><a href="#__codelineno-0-442"><span class="linenos" data-linenos="442 "></span></a>                <span class="n">curr_frame_boxes</span><span class="p">,</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a><a href="#__codelineno-0-443"><span class="linenos" data-linenos="443 "></span></a>                <span class="n">prev_frame_boxes</span><span class="p">,</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a><a href="#__codelineno-0-444"><span class="linenos" data-linenos="444 "></span></a>            <span class="p">)</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a><a href="#__codelineno-0-445"><span class="linenos" data-linenos="445 "></span></a>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a><a href="#__codelineno-0-446"><span class="linenos" data-linenos="446 "></span></a>            <span class="n">match_i</span><span class="p">,</span> <span class="n">match_j</span> <span class="o">=</span> <span class="n">linear_sum_assignment</span><span class="p">((</span><span class="o">-</span><span class="n">traj_score</span><span class="p">))</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a><a href="#__codelineno-0-447"><span class="linenos" data-linenos="447 "></span></a>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a><a href="#__codelineno-0-448"><span class="linenos" data-linenos="448 "></span></a>            <span class="n">track_ids</span> <span class="o">=</span> <span class="n">instance_ids</span><span class="o">.</span><span class="n">new_full</span><span class="p">((</span><span class="n">frame</span><span class="o">.</span><span class="n">num_detected</span><span class="p">,),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a><a href="#__codelineno-0-449"><span class="linenos" data-linenos="449 "></span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">match_i</span><span class="p">,</span> <span class="n">match_j</span><span class="p">):</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a><a href="#__codelineno-0-450"><span class="linenos" data-linenos="450 "></span></a>                <span class="c1"># The overlap threshold is multiplied by the number of times the unique track j is matched to an</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a><a href="#__codelineno-0-451"><span class="linenos" data-linenos="451 "></span></a>                <span class="c1"># instance out of all instances in the window excluding the current frame.</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a><a href="#__codelineno-0-452"><span class="linenos" data-linenos="452 "></span></a>                <span class="c1">#</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a><a href="#__codelineno-0-453"><span class="linenos" data-linenos="453 "></span></a>                <span class="c1"># So if this is correct, the threshold is higher for matching an instance from the current frame</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a><a href="#__codelineno-0-454"><span class="linenos" data-linenos="454 "></span></a>                <span class="c1"># to an existing track if that track has already been matched several times.</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a><a href="#__codelineno-0-455"><span class="linenos" data-linenos="455 "></span></a>                <span class="c1"># So if an existing track in the window has been matched a lot, it gets harder to match to that track.</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a><a href="#__codelineno-0-456"><span class="linenos" data-linenos="456 "></span></a>                <span class="n">thresh</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a><a href="#__codelineno-0-457"><span class="linenos" data-linenos="457 "></span></a>                    <span class="n">overlap_thresh</span> <span class="o">*</span> <span class="n">id_inds</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a><a href="#__codelineno-0-458"><span class="linenos" data-linenos="458 "></span></a>                    <span class="k">if</span> <span class="n">mult_thresh</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a><a href="#__codelineno-0-459"><span class="linenos" data-linenos="459 "></span></a>                    <span class="k">else</span> <span class="n">overlap_thresh</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a><a href="#__codelineno-0-460"><span class="linenos" data-linenos="460 "></span></a>                <span class="p">)</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a><a href="#__codelineno-0-461"><span class="linenos" data-linenos="461 "></span></a>                <span class="k">if</span> <span class="n">n_traj</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_tracks</span> <span class="ow">or</span> <span class="n">traj_score</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">:</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a><a href="#__codelineno-0-462"><span class="linenos" data-linenos="462 "></span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a><a href="#__codelineno-0-463"><span class="linenos" data-linenos="463 "></span></a>                        <span class="sa">f</span><span class="s2">&quot;Assigning instance </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> to track </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2"> with id </span><span class="si">{</span><span class="n">unique_ids</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a><a href="#__codelineno-0-464"><span class="linenos" data-linenos="464 "></span></a>                    <span class="p">)</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a><a href="#__codelineno-0-465"><span class="linenos" data-linenos="465 "></span></a>                    <span class="n">track_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique_ids</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a><a href="#__codelineno-0-466"><span class="linenos" data-linenos="466 "></span></a>                    <span class="n">frame</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">track_score</span> <span class="o">=</span> <span class="n">traj_score</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a><a href="#__codelineno-0-467"><span class="linenos" data-linenos="467 "></span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;track_ids: </span><span class="si">{</span><span class="n">track_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a><a href="#__codelineno-0-468"><span class="linenos" data-linenos="468 "></span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">num_detected</span><span class="p">):</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a><a href="#__codelineno-0-469"><span class="linenos" data-linenos="469 "></span></a>                <span class="k">if</span> <span class="n">track_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a><a href="#__codelineno-0-470"><span class="linenos" data-linenos="470 "></span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating new track </span><span class="si">{</span><span class="n">curr_track</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a><a href="#__codelineno-0-471"><span class="linenos" data-linenos="471 "></span></a>                    <span class="n">curr_track</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a><a href="#__codelineno-0-472"><span class="linenos" data-linenos="472 "></span></a>                    <span class="n">track_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_track</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a><a href="#__codelineno-0-473"><span class="linenos" data-linenos="473 "></span></a>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a><a href="#__codelineno-0-474"><span class="linenos" data-linenos="474 "></span></a>            <span class="n">frame</span><span class="o">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">(</span><span class="n">match_i</span><span class="p">,</span> <span class="n">match_j</span><span class="p">)</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a><a href="#__codelineno-0-475"><span class="linenos" data-linenos="475 "></span></a>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a><a href="#__codelineno-0-476"><span class="linenos" data-linenos="476 "></span></a>            <span class="k">for</span> <span class="n">instance</span><span class="p">,</span> <span class="n">track_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">instances</span><span class="p">,</span> <span class="n">track_ids</span><span class="p">):</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a><a href="#__codelineno-0-477"><span class="linenos" data-linenos="477 "></span></a>                <span class="n">instance</span><span class="o">.</span><span class="n">pred_track_id</span> <span class="o">=</span> <span class="n">track_id</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a><a href="#__codelineno-0-478"><span class="linenos" data-linenos="478 "></span></a>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a><a href="#__codelineno-0-479"><span class="linenos" data-linenos="479 "></span></a>            <span class="n">tracked_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a><a href="#__codelineno-0-480"><span class="linenos" data-linenos="480 "></span></a>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a><a href="#__codelineno-0-481"><span class="linenos" data-linenos="481 "></span></a>            <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">has_instances</span><span class="p">():</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a><a href="#__codelineno-0-482"><span class="linenos" data-linenos="482 "></span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span><span class="o">.</span><span class="n">add_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a><a href="#__codelineno-0-483"><span class="linenos" data-linenos="483 "></span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">num_frames_tracked</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a><a href="#__codelineno-0-484"><span class="linenos" data-linenos="484 "></span></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a><a href="#__codelineno-0-485"><span class="linenos" data-linenos="485 "></span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span><span class="o">.</span><span class="n">increment_gaps</span><span class="p">([])</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a><a href="#__codelineno-0-486"><span class="linenos" data-linenos="486 "></span></a>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a><a href="#__codelineno-0-487"><span class="linenos" data-linenos="487 "></span></a>        <span class="k">return</span> <span class="n">tracked_frames</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a><a href="#__codelineno-0-488"><span class="linenos" data-linenos="488 "></span></a>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a><a href="#__codelineno-0-489"><span class="linenos" data-linenos="489 "></span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_run_frame_by_frame_tracker</span><span class="p">(</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a><a href="#__codelineno-0-490"><span class="linenos" data-linenos="490 "></span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">GlobalTrackingTransformer</span><span class="p">,</span> <span class="n">frames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Frame</span><span class="p">]</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a><a href="#__codelineno-0-491"><span class="linenos" data-linenos="491 "></span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Frame</span><span class="p">:</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a><a href="#__codelineno-0-492"><span class="linenos" data-linenos="492 "></span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run global tracker performs the actual tracking.</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a><a href="#__codelineno-0-493"><span class="linenos" data-linenos="493 "></span></a>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a><a href="#__codelineno-0-494"><span class="linenos" data-linenos="494 "></span></a><span class="sd">        Uses Hungarian algorithm to do track assigning.</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a><a href="#__codelineno-0-495"><span class="linenos" data-linenos="495 "></span></a>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a><a href="#__codelineno-0-496"><span class="linenos" data-linenos="496 "></span></a><span class="sd">        Args:</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a><a href="#__codelineno-0-497"><span class="linenos" data-linenos="497 "></span></a><span class="sd">            model: the pretrained GlobalTrackingTransformer to be used for inference</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a><a href="#__codelineno-0-498"><span class="linenos" data-linenos="498 "></span></a><span class="sd">            frames: A list of Frames containing reid features. See `dreem.io.data_structures` for more info.</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a><a href="#__codelineno-0-499"><span class="linenos" data-linenos="499 "></span></a>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a><a href="#__codelineno-0-500"><span class="linenos" data-linenos="500 "></span></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a><a href="#__codelineno-0-501"><span class="linenos" data-linenos="501 "></span></a><span class="sd">            query_frame: The query frame now populated with the pred_track_ids.</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a><a href="#__codelineno-0-502"><span class="linenos" data-linenos="502 "></span></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a><a href="#__codelineno-0-503"><span class="linenos" data-linenos="503 "></span></a>        <span class="c1"># *: each item in frames is a frame in the window. So it follows</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a><a href="#__codelineno-0-504"><span class="linenos" data-linenos="504 "></span></a>        <span class="c1">#    that each frame in the window has * detected instances.</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a><a href="#__codelineno-0-505"><span class="linenos" data-linenos="505 "></span></a>        <span class="c1"># D: embedding dimension.</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a><a href="#__codelineno-0-506"><span class="linenos" data-linenos="506 "></span></a>        <span class="c1"># total_instances: number of instances in the window.</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a><a href="#__codelineno-0-507"><span class="linenos" data-linenos="507 "></span></a>        <span class="c1"># N_i: number of detected instances in i-th frame of window.</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a><a href="#__codelineno-0-508"><span class="linenos" data-linenos="508 "></span></a>        <span class="c1"># instances_per_frame: a list of number of instances in each frame of the window.</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a><a href="#__codelineno-0-509"><span class="linenos" data-linenos="509 "></span></a>        <span class="c1"># n_query: number of instances in current/query frame (rightmost frame of the window).</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a><a href="#__codelineno-0-510"><span class="linenos" data-linenos="510 "></span></a>        <span class="c1"># n_nonquery: number of instances in the window excluding the current/query frame.</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a><a href="#__codelineno-0-511"><span class="linenos" data-linenos="511 "></span></a>        <span class="c1"># window_size: length of window.</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a><a href="#__codelineno-0-512"><span class="linenos" data-linenos="512 "></span></a>        <span class="c1"># L: number of decoder blocks.</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a><a href="#__codelineno-0-513"><span class="linenos" data-linenos="513 "></span></a>        <span class="c1"># n_traj: number of existing tracks within the window so far.</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a><a href="#__codelineno-0-514"><span class="linenos" data-linenos="514 "></span></a>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a><a href="#__codelineno-0-515"><span class="linenos" data-linenos="515 "></span></a>        <span class="c1"># Number of instances in each frame of the window.</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a><a href="#__codelineno-0-516"><span class="linenos" data-linenos="516 "></span></a>        <span class="c1"># E.g.: instances_per_frame: [4, 5, 6, 7]; window of length 4 with 4 detected instances in the first frame of the window.</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a><a href="#__codelineno-0-517"><span class="linenos" data-linenos="517 "></span></a>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a><a href="#__codelineno-0-518"><span class="linenos" data-linenos="518 "></span></a>        <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a><a href="#__codelineno-0-519"><span class="linenos" data-linenos="519 "></span></a>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a><a href="#__codelineno-0-520"><span class="linenos" data-linenos="520 "></span></a>        <span class="n">query_ind</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a><a href="#__codelineno-0-521"><span class="linenos" data-linenos="521 "></span></a>        <span class="n">query_frame</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="n">query_ind</span><span class="p">]</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a><a href="#__codelineno-0-522"><span class="linenos" data-linenos="522 "></span></a>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a><a href="#__codelineno-0-523"><span class="linenos" data-linenos="523 "></span></a>        <span class="n">query_instances</span> <span class="o">=</span> <span class="n">query_frame</span><span class="o">.</span><span class="n">instances</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a><a href="#__codelineno-0-524"><span class="linenos" data-linenos="524 "></span></a>        <span class="n">all_instances</span> <span class="o">=</span> <span class="p">[</span><span class="n">instance</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span> <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">instances</span><span class="p">]</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a><a href="#__codelineno-0-525"><span class="linenos" data-linenos="525 "></span></a>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a><a href="#__codelineno-0-526"><span class="linenos" data-linenos="526 "></span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Frame </span><span class="si">{</span><span class="n">query_frame</span><span class="o">.</span><span class="n">frame_id</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a><a href="#__codelineno-0-527"><span class="linenos" data-linenos="527 "></span></a>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a><a href="#__codelineno-0-528"><span class="linenos" data-linenos="528 "></span></a>        <span class="n">instances_per_frame</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">num_detected</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">]</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a><a href="#__codelineno-0-529"><span class="linenos" data-linenos="529 "></span></a>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a><a href="#__codelineno-0-530"><span class="linenos" data-linenos="530 "></span></a>        <span class="n">total_instances</span><span class="p">,</span> <span class="n">window_size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">instances_per_frame</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a><a href="#__codelineno-0-531"><span class="linenos" data-linenos="531 "></span></a>            <span class="n">instances_per_frame</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a><a href="#__codelineno-0-532"><span class="linenos" data-linenos="532 "></span></a>        <span class="p">)</span>  <span class="c1"># Number of instances in window; length of window.</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a><a href="#__codelineno-0-533"><span class="linenos" data-linenos="533 "></span></a>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a><a href="#__codelineno-0-534"><span class="linenos" data-linenos="534 "></span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;total_instances: </span><span class="si">{</span><span class="n">total_instances</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a><a href="#__codelineno-0-535"><span class="linenos" data-linenos="535 "></span></a>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a><a href="#__codelineno-0-536"><span class="linenos" data-linenos="536 "></span></a>        <span class="n">overlap_thresh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap_thresh</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a><a href="#__codelineno-0-537"><span class="linenos" data-linenos="537 "></span></a>        <span class="n">mult_thresh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_thresh</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a><a href="#__codelineno-0-538"><span class="linenos" data-linenos="538 "></span></a>        <span class="n">n_traj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span><span class="o">.</span><span class="n">n_tracks</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a><a href="#__codelineno-0-539"><span class="linenos" data-linenos="539 "></span></a>        <span class="n">curr_track</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span><span class="o">.</span><span class="n">curr_track</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a><a href="#__codelineno-0-540"><span class="linenos" data-linenos="540 "></span></a>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a><a href="#__codelineno-0-541"><span class="linenos" data-linenos="541 "></span></a>        <span class="n">reid_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">frame</span><span class="o">.</span><span class="n">get_features</span><span class="p">()</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a><a href="#__codelineno-0-542"><span class="linenos" data-linenos="542 "></span></a>            <span class="kc">None</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a><a href="#__codelineno-0-543"><span class="linenos" data-linenos="543 "></span></a>        <span class="p">]</span>  <span class="c1"># (1, total_instances, D=512)</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a><a href="#__codelineno-0-544"><span class="linenos" data-linenos="544 "></span></a>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a><a href="#__codelineno-0-545"><span class="linenos" data-linenos="545 "></span></a>        <span class="c1"># (L=1, n_query, total_instances)</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a><a href="#__codelineno-0-546"><span class="linenos" data-linenos="546 "></span></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a><a href="#__codelineno-0-547"><span class="linenos" data-linenos="547 "></span></a>            <span class="n">asso_matrix</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">all_instances</span><span class="p">,</span> <span class="n">query_instances</span><span class="p">)</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a><a href="#__codelineno-0-548"><span class="linenos" data-linenos="548 "></span></a>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a><a href="#__codelineno-0-549"><span class="linenos" data-linenos="549 "></span></a>        <span class="n">asso_output</span> <span class="o">=</span> <span class="n">asso_matrix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a><a href="#__codelineno-0-550"><span class="linenos" data-linenos="550 "></span></a>            <span class="n">instances_per_frame</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a><a href="#__codelineno-0-551"><span class="linenos" data-linenos="551 "></span></a>        <span class="p">)</span>  <span class="c1"># (window_size, n_query, N_i)</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a><a href="#__codelineno-0-552"><span class="linenos" data-linenos="552 "></span></a>        <span class="n">asso_output</span> <span class="o">=</span> <span class="n">model_utils</span><span class="o">.</span><span class="n">softmax_asso</span><span class="p">(</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a><a href="#__codelineno-0-553"><span class="linenos" data-linenos="553 "></span></a>            <span class="n">asso_output</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a><a href="#__codelineno-0-554"><span class="linenos" data-linenos="554 "></span></a>        <span class="p">)</span>  <span class="c1"># (window_size, n_query, N_i)</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a><a href="#__codelineno-0-555"><span class="linenos" data-linenos="555 "></span></a>        <span class="n">asso_output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">asso_output</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>  <span class="c1"># (n_query, total_instances)</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a><a href="#__codelineno-0-556"><span class="linenos" data-linenos="556 "></span></a>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a><a href="#__codelineno-0-557"><span class="linenos" data-linenos="557 "></span></a>        <span class="n">asso_output_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a><a href="#__codelineno-0-558"><span class="linenos" data-linenos="558 "></span></a>            <span class="n">asso_output</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a><a href="#__codelineno-0-559"><span class="linenos" data-linenos="559 "></span></a>            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Instance </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">asso_output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])],</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a><a href="#__codelineno-0-560"><span class="linenos" data-linenos="560 "></span></a>        <span class="p">)</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a><a href="#__codelineno-0-561"><span class="linenos" data-linenos="561 "></span></a>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a><a href="#__codelineno-0-562"><span class="linenos" data-linenos="562 "></span></a>        <span class="n">asso_output_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Instances&quot;</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a><a href="#__codelineno-0-563"><span class="linenos" data-linenos="563 "></span></a>        <span class="n">asso_output_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Instances&quot;</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a><a href="#__codelineno-0-564"><span class="linenos" data-linenos="564 "></span></a>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a><a href="#__codelineno-0-565"><span class="linenos" data-linenos="565 "></span></a>        <span class="n">query_frame</span><span class="o">.</span><span class="n">add_traj_score</span><span class="p">(</span><span class="s2">&quot;asso_output&quot;</span><span class="p">,</span> <span class="n">asso_output_df</span><span class="p">)</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a><a href="#__codelineno-0-566"><span class="linenos" data-linenos="566 "></span></a>        <span class="n">query_frame</span><span class="o">.</span><span class="n">asso_output</span> <span class="o">=</span> <span class="n">asso_matrix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a><a href="#__codelineno-0-567"><span class="linenos" data-linenos="567 "></span></a>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a><a href="#__codelineno-0-568"><span class="linenos" data-linenos="568 "></span></a>        <span class="n">n_query</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a><a href="#__codelineno-0-569"><span class="linenos" data-linenos="569 "></span></a>            <span class="n">query_frame</span><span class="o">.</span><span class="n">num_detected</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a><a href="#__codelineno-0-570"><span class="linenos" data-linenos="570 "></span></a>        <span class="p">)</span>  <span class="c1"># Number of instances in the current/query frame.</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a><a href="#__codelineno-0-571"><span class="linenos" data-linenos="571 "></span></a>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a><a href="#__codelineno-0-572"><span class="linenos" data-linenos="572 "></span></a>        <span class="n">n_nonquery</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a><a href="#__codelineno-0-573"><span class="linenos" data-linenos="573 "></span></a>            <span class="n">total_instances</span> <span class="o">-</span> <span class="n">n_query</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a><a href="#__codelineno-0-574"><span class="linenos" data-linenos="574 "></span></a>        <span class="p">)</span>  <span class="c1"># Number of instances in the window not including the current/query frame.</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a><a href="#__codelineno-0-575"><span class="linenos" data-linenos="575 "></span></a>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a><a href="#__codelineno-0-576"><span class="linenos" data-linenos="576 "></span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n_nonquery: </span><span class="si">{</span><span class="n">n_nonquery</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a><a href="#__codelineno-0-577"><span class="linenos" data-linenos="577 "></span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n_query: </span><span class="si">{</span><span class="n">n_query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a><a href="#__codelineno-0-578"><span class="linenos" data-linenos="578 "></span></a>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a><a href="#__codelineno-0-579"><span class="linenos" data-linenos="579 "></span></a>        <span class="n">instance_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a><a href="#__codelineno-0-580"><span class="linenos" data-linenos="580 "></span></a>            <span class="p">[</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a><a href="#__codelineno-0-581"><span class="linenos" data-linenos="581 "></span></a>                <span class="n">x</span><span class="o">.</span><span class="n">get_pred_track_ids</span><span class="p">()</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a><a href="#__codelineno-0-582"><span class="linenos" data-linenos="582 "></span></a>                <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a><a href="#__codelineno-0-583"><span class="linenos" data-linenos="583 "></span></a>                <span class="k">if</span> <span class="n">batch_idx</span> <span class="o">!=</span> <span class="n">query_ind</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a><a href="#__codelineno-0-584"><span class="linenos" data-linenos="584 "></span></a>            <span class="p">],</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a><a href="#__codelineno-0-585"><span class="linenos" data-linenos="585 "></span></a>            <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a><a href="#__codelineno-0-586"><span class="linenos" data-linenos="586 "></span></a>        <span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a><a href="#__codelineno-0-587"><span class="linenos" data-linenos="587 "></span></a>            <span class="n">n_nonquery</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a><a href="#__codelineno-0-588"><span class="linenos" data-linenos="588 "></span></a>        <span class="p">)</span>  <span class="c1"># (n_nonquery,)</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a><a href="#__codelineno-0-589"><span class="linenos" data-linenos="589 "></span></a>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a><a href="#__codelineno-0-590"><span class="linenos" data-linenos="590 "></span></a>        <span class="n">query_inds</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a><a href="#__codelineno-0-591"><span class="linenos" data-linenos="591 "></span></a>            <span class="n">x</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a><a href="#__codelineno-0-592"><span class="linenos" data-linenos="592 "></span></a>            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a><a href="#__codelineno-0-593"><span class="linenos" data-linenos="593 "></span></a>                <span class="nb">sum</span><span class="p">(</span><span class="n">instances_per_frame</span><span class="p">[:</span><span class="n">query_ind</span><span class="p">]),</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a><a href="#__codelineno-0-594"><span class="linenos" data-linenos="594 "></span></a>                <span class="nb">sum</span><span class="p">(</span><span class="n">instances_per_frame</span><span class="p">[:</span> <span class="n">query_ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]),</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a><a href="#__codelineno-0-595"><span class="linenos" data-linenos="595 "></span></a>            <span class="p">)</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a><a href="#__codelineno-0-596"><span class="linenos" data-linenos="596 "></span></a>        <span class="p">]</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a><a href="#__codelineno-0-597"><span class="linenos" data-linenos="597 "></span></a>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a><a href="#__codelineno-0-598"><span class="linenos" data-linenos="598 "></span></a>        <span class="n">nonquery_inds</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_instances</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query_inds</span><span class="p">]</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a><a href="#__codelineno-0-599"><span class="linenos" data-linenos="599 "></span></a>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a><a href="#__codelineno-0-600"><span class="linenos" data-linenos="600 "></span></a>        <span class="c1"># instead should we do model(nonquery_instances, query_instances)?</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a><a href="#__codelineno-0-601"><span class="linenos" data-linenos="601 "></span></a>        <span class="n">asso_nonquery</span> <span class="o">=</span> <span class="n">asso_output</span><span class="p">[:,</span> <span class="n">nonquery_inds</span><span class="p">]</span>  <span class="c1"># (n_query, n_nonquery)</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a><a href="#__codelineno-0-602"><span class="linenos" data-linenos="602 "></span></a>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a><a href="#__codelineno-0-603"><span class="linenos" data-linenos="603 "></span></a>        <span class="n">asso_nonquery_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a><a href="#__codelineno-0-604"><span class="linenos" data-linenos="604 "></span></a>            <span class="n">asso_nonquery</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="n">nonquery_inds</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a><a href="#__codelineno-0-605"><span class="linenos" data-linenos="605 "></span></a>        <span class="p">)</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a><a href="#__codelineno-0-606"><span class="linenos" data-linenos="606 "></span></a>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a><a href="#__codelineno-0-607"><span class="linenos" data-linenos="607 "></span></a>        <span class="n">asso_nonquery_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Current Frame Instances&quot;</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a><a href="#__codelineno-0-608"><span class="linenos" data-linenos="608 "></span></a>        <span class="n">asso_nonquery_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Nonquery Instances&quot;</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a><a href="#__codelineno-0-609"><span class="linenos" data-linenos="609 "></span></a>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a><a href="#__codelineno-0-610"><span class="linenos" data-linenos="610 "></span></a>        <span class="n">query_frame</span><span class="o">.</span><span class="n">add_traj_score</span><span class="p">(</span><span class="s2">&quot;asso_nonquery&quot;</span><span class="p">,</span> <span class="n">asso_nonquery_df</span><span class="p">)</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a><a href="#__codelineno-0-611"><span class="linenos" data-linenos="611 "></span></a>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a><a href="#__codelineno-0-612"><span class="linenos" data-linenos="612 "></span></a>        <span class="c1"># get raw bbox coords of prev frame instances from frame.instances_per_frame</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a><a href="#__codelineno-0-613"><span class="linenos" data-linenos="613 "></span></a>        <span class="n">query_boxes_px</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a><a href="#__codelineno-0-614"><span class="linenos" data-linenos="614 "></span></a>            <span class="p">[</span><span class="n">instance</span><span class="o">.</span><span class="n">bbox</span> <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">query_frame</span><span class="o">.</span><span class="n">instances</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a><a href="#__codelineno-0-615"><span class="linenos" data-linenos="615 "></span></a>        <span class="p">)</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a><a href="#__codelineno-0-616"><span class="linenos" data-linenos="616 "></span></a>        <span class="n">nonquery_boxes_px</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a><a href="#__codelineno-0-617"><span class="linenos" data-linenos="617 "></span></a>            <span class="p">[</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a><a href="#__codelineno-0-618"><span class="linenos" data-linenos="618 "></span></a>                <span class="n">instance</span><span class="o">.</span><span class="n">bbox</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a><a href="#__codelineno-0-619"><span class="linenos" data-linenos="619 "></span></a>                <span class="k">for</span> <span class="n">nonquery_frame</span> <span class="ow">in</span> <span class="n">frames</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a><a href="#__codelineno-0-620"><span class="linenos" data-linenos="620 "></span></a>                <span class="k">if</span> <span class="n">nonquery_frame</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">!=</span> <span class="n">query_frame</span><span class="o">.</span><span class="n">frame_id</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a><a href="#__codelineno-0-621"><span class="linenos" data-linenos="621 "></span></a>                <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">nonquery_frame</span><span class="o">.</span><span class="n">instances</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a><a href="#__codelineno-0-622"><span class="linenos" data-linenos="622 "></span></a>            <span class="p">],</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a><a href="#__codelineno-0-623"><span class="linenos" data-linenos="623 "></span></a>            <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a><a href="#__codelineno-0-624"><span class="linenos" data-linenos="624 "></span></a>        <span class="p">)</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a><a href="#__codelineno-0-625"><span class="linenos" data-linenos="625 "></span></a>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a><a href="#__codelineno-0-626"><span class="linenos" data-linenos="626 "></span></a>        <span class="n">pred_boxes</span> <span class="o">=</span> <span class="n">model_utils</span><span class="o">.</span><span class="n">get_boxes</span><span class="p">(</span><span class="n">all_instances</span><span class="p">)</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a><a href="#__codelineno-0-627"><span class="linenos" data-linenos="627 "></span></a>        <span class="n">query_boxes</span> <span class="o">=</span> <span class="n">pred_boxes</span><span class="p">[</span><span class="n">query_inds</span><span class="p">]</span>  <span class="c1"># n_k x 4</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a><a href="#__codelineno-0-628"><span class="linenos" data-linenos="628 "></span></a>        <span class="n">nonquery_boxes</span> <span class="o">=</span> <span class="n">pred_boxes</span><span class="p">[</span><span class="n">nonquery_inds</span><span class="p">]</span>  <span class="c1"># n_nonquery x 4</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a><a href="#__codelineno-0-629"><span class="linenos" data-linenos="629 "></span></a>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a><a href="#__codelineno-0-630"><span class="linenos" data-linenos="630 "></span></a>        <span class="n">unique_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">instance_ids</span><span class="p">)</span>  <span class="c1"># (n_nonquery,)</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a><a href="#__codelineno-0-631"><span class="linenos" data-linenos="631 "></span></a>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a><a href="#__codelineno-0-632"><span class="linenos" data-linenos="632 "></span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Instance IDs: </span><span class="si">{</span><span class="n">instance_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a><a href="#__codelineno-0-633"><span class="linenos" data-linenos="633 "></span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unique ids: </span><span class="si">{</span><span class="n">unique_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a><a href="#__codelineno-0-634"><span class="linenos" data-linenos="634 "></span></a>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a><a href="#__codelineno-0-635"><span class="linenos" data-linenos="635 "></span></a>        <span class="n">id_inds</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a><a href="#__codelineno-0-636"><span class="linenos" data-linenos="636 "></span></a>            <span class="n">unique_ids</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">instance_ids</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a><a href="#__codelineno-0-637"><span class="linenos" data-linenos="637 "></span></a>        <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>  <span class="c1"># (n_nonquery, n_traj)</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a><a href="#__codelineno-0-638"><span class="linenos" data-linenos="638 "></span></a>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a><a href="#__codelineno-0-639"><span class="linenos" data-linenos="639 "></span></a>        <span class="c1">################################################################################</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a><a href="#__codelineno-0-640"><span class="linenos" data-linenos="640 "></span></a>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a><a href="#__codelineno-0-641"><span class="linenos" data-linenos="641 "></span></a>        <span class="c1"># reweighting hyper-parameters for association -&gt; they use 0.9</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a><a href="#__codelineno-0-642"><span class="linenos" data-linenos="642 "></span></a>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a><a href="#__codelineno-0-643"><span class="linenos" data-linenos="643 "></span></a>        <span class="n">traj_score</span> <span class="o">=</span> <span class="n">post_processing</span><span class="o">.</span><span class="n">weight_decay_time</span><span class="p">(</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a><a href="#__codelineno-0-644"><span class="linenos" data-linenos="644 "></span></a>            <span class="n">asso_nonquery</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">decay_time</span><span class="p">,</span> <span class="n">reid_features</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">query_ind</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a><a href="#__codelineno-0-645"><span class="linenos" data-linenos="645 "></span></a>        <span class="p">)</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a><a href="#__codelineno-0-646"><span class="linenos" data-linenos="646 "></span></a>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a><a href="#__codelineno-0-647"><span class="linenos" data-linenos="647 "></span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">decay_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">decay_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a><a href="#__codelineno-0-648"><span class="linenos" data-linenos="648 "></span></a>            <span class="n">decay_time_traj_score</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a><a href="#__codelineno-0-649"><span class="linenos" data-linenos="649 "></span></a>                <span class="n">traj_score</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="n">nonquery_inds</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a><a href="#__codelineno-0-650"><span class="linenos" data-linenos="650 "></span></a>            <span class="p">)</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a><a href="#__codelineno-0-651"><span class="linenos" data-linenos="651 "></span></a>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a><a href="#__codelineno-0-652"><span class="linenos" data-linenos="652 "></span></a>            <span class="n">decay_time_traj_score</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Query Instances&quot;</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a><a href="#__codelineno-0-653"><span class="linenos" data-linenos="653 "></span></a>            <span class="n">decay_time_traj_score</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Nonquery Instances&quot;</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a><a href="#__codelineno-0-654"><span class="linenos" data-linenos="654 "></span></a>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a><a href="#__codelineno-0-655"><span class="linenos" data-linenos="655 "></span></a>            <span class="n">query_frame</span><span class="o">.</span><span class="n">add_traj_score</span><span class="p">(</span><span class="s2">&quot;decay_time&quot;</span><span class="p">,</span> <span class="n">decay_time_traj_score</span><span class="p">)</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a><a href="#__codelineno-0-656"><span class="linenos" data-linenos="656 "></span></a>        <span class="c1">################################################################################</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a><a href="#__codelineno-0-657"><span class="linenos" data-linenos="657 "></span></a>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a><a href="#__codelineno-0-658"><span class="linenos" data-linenos="658 "></span></a>        <span class="c1"># (n_query x n_nonquery) x (n_nonquery x n_traj) --&gt; n_query x n_traj</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a><a href="#__codelineno-0-659"><span class="linenos" data-linenos="659 "></span></a>        <span class="n">traj_score</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">traj_score</span><span class="p">,</span> <span class="n">id_inds</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>  <span class="c1"># (n_query, n_traj)</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a><a href="#__codelineno-0-660"><span class="linenos" data-linenos="660 "></span></a>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a><a href="#__codelineno-0-661"><span class="linenos" data-linenos="661 "></span></a>        <span class="n">traj_score_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a><a href="#__codelineno-0-662"><span class="linenos" data-linenos="662 "></span></a>            <span class="n">traj_score</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="n">unique_ids</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a><a href="#__codelineno-0-663"><span class="linenos" data-linenos="663 "></span></a>        <span class="p">)</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a><a href="#__codelineno-0-664"><span class="linenos" data-linenos="664 "></span></a>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a><a href="#__codelineno-0-665"><span class="linenos" data-linenos="665 "></span></a>        <span class="n">traj_score_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Current Frame Instances&quot;</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a><a href="#__codelineno-0-666"><span class="linenos" data-linenos="666 "></span></a>        <span class="n">traj_score_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Unique IDs&quot;</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a><a href="#__codelineno-0-667"><span class="linenos" data-linenos="667 "></span></a>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a><a href="#__codelineno-0-668"><span class="linenos" data-linenos="668 "></span></a>        <span class="n">query_frame</span><span class="o">.</span><span class="n">add_traj_score</span><span class="p">(</span><span class="s2">&quot;traj_score&quot;</span><span class="p">,</span> <span class="n">traj_score_df</span><span class="p">)</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a><a href="#__codelineno-0-669"><span class="linenos" data-linenos="669 "></span></a>        <span class="c1">################################################################################</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a><a href="#__codelineno-0-670"><span class="linenos" data-linenos="670 "></span></a>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a><a href="#__codelineno-0-671"><span class="linenos" data-linenos="671 "></span></a>        <span class="c1"># with iou -&gt; combining with location in tracker, they set to True</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a><a href="#__codelineno-0-672"><span class="linenos" data-linenos="672 "></span></a>        <span class="c1"># todo -&gt; should also work without pos_embed</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a><a href="#__codelineno-0-673"><span class="linenos" data-linenos="673 "></span></a>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a><a href="#__codelineno-0-674"><span class="linenos" data-linenos="674 "></span></a>        <span class="k">if</span> <span class="n">id_inds</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a><a href="#__codelineno-0-675"><span class="linenos" data-linenos="675 "></span></a>            <span class="c1"># this throws error, think we need to slice?</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a><a href="#__codelineno-0-676"><span class="linenos" data-linenos="676 "></span></a>            <span class="c1"># last_inds = (id_inds * torch.arange(</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a><a href="#__codelineno-0-677"><span class="linenos" data-linenos="677 "></span></a>            <span class="c1">#    n_nonquery, device=id_inds.device)[:, None]).max(dim=0)[1] # n_traj</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a><a href="#__codelineno-0-678"><span class="linenos" data-linenos="678 "></span></a>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a><a href="#__codelineno-0-679"><span class="linenos" data-linenos="679 "></span></a>            <span class="n">last_inds</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a><a href="#__codelineno-0-680"><span class="linenos" data-linenos="680 "></span></a>                <span class="n">id_inds</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_nonquery</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">id_inds</span><span class="o">.</span><span class="n">device</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a><a href="#__codelineno-0-681"><span class="linenos" data-linenos="681 "></span></a>            <span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a><a href="#__codelineno-0-682"><span class="linenos" data-linenos="682 "></span></a>                <span class="mi">1</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a><a href="#__codelineno-0-683"><span class="linenos" data-linenos="683 "></span></a>            <span class="p">]</span>  <span class="c1"># M</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a><a href="#__codelineno-0-684"><span class="linenos" data-linenos="684 "></span></a>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a><a href="#__codelineno-0-685"><span class="linenos" data-linenos="685 "></span></a>            <span class="n">last_boxes</span> <span class="o">=</span> <span class="n">nonquery_boxes</span><span class="p">[</span><span class="n">last_inds</span><span class="p">]</span>  <span class="c1"># n_traj x 4</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a><a href="#__codelineno-0-686"><span class="linenos" data-linenos="686 "></span></a>            <span class="n">last_ious</span> <span class="o">=</span> <span class="n">post_processing</span><span class="o">.</span><span class="n">_pairwise_iou</span><span class="p">(</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a><a href="#__codelineno-0-687"><span class="linenos" data-linenos="687 "></span></a>                <span class="n">Boxes</span><span class="p">(</span><span class="n">query_boxes</span><span class="p">),</span> <span class="n">Boxes</span><span class="p">(</span><span class="n">last_boxes</span><span class="p">)</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a><a href="#__codelineno-0-688"><span class="linenos" data-linenos="688 "></span></a>            <span class="p">)</span>  <span class="c1"># n_k x M</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a><a href="#__codelineno-0-689"><span class="linenos" data-linenos="689 "></span></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a><a href="#__codelineno-0-690"><span class="linenos" data-linenos="690 "></span></a>            <span class="n">last_ious</span> <span class="o">=</span> <span class="n">traj_score</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="n">traj_score</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a><a href="#__codelineno-0-691"><span class="linenos" data-linenos="691 "></span></a>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a><a href="#__codelineno-0-692"><span class="linenos" data-linenos="692 "></span></a>        <span class="n">traj_score</span> <span class="o">=</span> <span class="n">post_processing</span><span class="o">.</span><span class="n">weight_iou</span><span class="p">(</span><span class="n">traj_score</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iou</span><span class="p">,</span> <span class="n">last_ious</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a><a href="#__codelineno-0-693"><span class="linenos" data-linenos="693 "></span></a>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a><a href="#__codelineno-0-694"><span class="linenos" data-linenos="694 "></span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iou</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">iou</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a><a href="#__codelineno-0-695"><span class="linenos" data-linenos="695 "></span></a>            <span class="n">iou_traj_score</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a><a href="#__codelineno-0-696"><span class="linenos" data-linenos="696 "></span></a>                <span class="n">traj_score</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="n">unique_ids</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a><a href="#__codelineno-0-697"><span class="linenos" data-linenos="697 "></span></a>            <span class="p">)</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a><a href="#__codelineno-0-698"><span class="linenos" data-linenos="698 "></span></a>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a><a href="#__codelineno-0-699"><span class="linenos" data-linenos="699 "></span></a>            <span class="n">iou_traj_score</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Current Frame Instances&quot;</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a><a href="#__codelineno-0-700"><span class="linenos" data-linenos="700 "></span></a>            <span class="n">iou_traj_score</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Unique IDs&quot;</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a><a href="#__codelineno-0-701"><span class="linenos" data-linenos="701 "></span></a>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a><a href="#__codelineno-0-702"><span class="linenos" data-linenos="702 "></span></a>            <span class="n">query_frame</span><span class="o">.</span><span class="n">add_traj_score</span><span class="p">(</span><span class="s2">&quot;weight_iou&quot;</span><span class="p">,</span> <span class="n">iou_traj_score</span><span class="p">)</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a><a href="#__codelineno-0-703"><span class="linenos" data-linenos="703 "></span></a>        <span class="c1">################################################################################</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a><a href="#__codelineno-0-704"><span class="linenos" data-linenos="704 "></span></a>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a><a href="#__codelineno-0-705"><span class="linenos" data-linenos="705 "></span></a>        <span class="c1"># threshold for continuing a tracking or starting a new track -&gt; they use 1.0</span>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a><a href="#__codelineno-0-706"><span class="linenos" data-linenos="706 "></span></a>        <span class="c1"># todo -&gt; should also work without pos_embed</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a><a href="#__codelineno-0-707"><span class="linenos" data-linenos="707 "></span></a>        <span class="n">traj_score</span> <span class="o">=</span> <span class="n">post_processing</span><span class="o">.</span><span class="n">filter_max_center_dist</span><span class="p">(</span>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a><a href="#__codelineno-0-708"><span class="linenos" data-linenos="708 "></span></a>            <span class="n">traj_score</span><span class="p">,</span>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a><a href="#__codelineno-0-709"><span class="linenos" data-linenos="709 "></span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">max_center_dist</span><span class="p">,</span>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a><a href="#__codelineno-0-710"><span class="linenos" data-linenos="710 "></span></a>            <span class="n">id_inds</span><span class="p">,</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a><a href="#__codelineno-0-711"><span class="linenos" data-linenos="711 "></span></a>            <span class="n">query_boxes_px</span><span class="p">,</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a><a href="#__codelineno-0-712"><span class="linenos" data-linenos="712 "></span></a>            <span class="n">nonquery_boxes_px</span><span class="p">,</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a><a href="#__codelineno-0-713"><span class="linenos" data-linenos="713 "></span></a>        <span class="p">)</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a><a href="#__codelineno-0-714"><span class="linenos" data-linenos="714 "></span></a>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a><a href="#__codelineno-0-715"><span class="linenos" data-linenos="715 "></span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_center_dist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_center_dist</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a><a href="#__codelineno-0-716"><span class="linenos" data-linenos="716 "></span></a>            <span class="n">max_center_dist_traj_score</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a><a href="#__codelineno-0-717"><span class="linenos" data-linenos="717 "></span></a>                <span class="n">traj_score</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="n">unique_ids</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a><a href="#__codelineno-0-718"><span class="linenos" data-linenos="718 "></span></a>            <span class="p">)</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a><a href="#__codelineno-0-719"><span class="linenos" data-linenos="719 "></span></a>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a><a href="#__codelineno-0-720"><span class="linenos" data-linenos="720 "></span></a>            <span class="n">max_center_dist_traj_score</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Current Frame Instances&quot;</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a><a href="#__codelineno-0-721"><span class="linenos" data-linenos="721 "></span></a>            <span class="n">max_center_dist_traj_score</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Unique IDs&quot;</span>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a><a href="#__codelineno-0-722"><span class="linenos" data-linenos="722 "></span></a>
<a id="__codelineno-0-723" name="__codelineno-0-723"></a><a href="#__codelineno-0-723"><span class="linenos" data-linenos="723 "></span></a>            <span class="n">query_frame</span><span class="o">.</span><span class="n">add_traj_score</span><span class="p">(</span><span class="s2">&quot;max_center_dist&quot;</span><span class="p">,</span> <span class="n">max_center_dist_traj_score</span><span class="p">)</span>
<a id="__codelineno-0-724" name="__codelineno-0-724"></a><a href="#__codelineno-0-724"><span class="linenos" data-linenos="724 "></span></a>
<a id="__codelineno-0-725" name="__codelineno-0-725"></a><a href="#__codelineno-0-725"><span class="linenos" data-linenos="725 "></span></a>        <span class="c1">################################################################################</span>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a><a href="#__codelineno-0-726"><span class="linenos" data-linenos="726 "></span></a>        <span class="n">scaled_traj_score</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">traj_score</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a><a href="#__codelineno-0-727"><span class="linenos" data-linenos="727 "></span></a>        <span class="n">scaled_traj_score_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a><a href="#__codelineno-0-728"><span class="linenos" data-linenos="728 "></span></a>            <span class="n">scaled_traj_score</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="n">unique_ids</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-0-729" name="__codelineno-0-729"></a><a href="#__codelineno-0-729"><span class="linenos" data-linenos="729 "></span></a>        <span class="p">)</span>
<a id="__codelineno-0-730" name="__codelineno-0-730"></a><a href="#__codelineno-0-730"><span class="linenos" data-linenos="730 "></span></a>        <span class="n">scaled_traj_score_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Current Frame Instances&quot;</span>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a><a href="#__codelineno-0-731"><span class="linenos" data-linenos="731 "></span></a>        <span class="n">scaled_traj_score_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Unique IDs&quot;</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a><a href="#__codelineno-0-732"><span class="linenos" data-linenos="732 "></span></a>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a><a href="#__codelineno-0-733"><span class="linenos" data-linenos="733 "></span></a>        <span class="n">query_frame</span><span class="o">.</span><span class="n">add_traj_score</span><span class="p">(</span><span class="s2">&quot;scaled&quot;</span><span class="p">,</span> <span class="n">scaled_traj_score_df</span><span class="p">)</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a><a href="#__codelineno-0-734"><span class="linenos" data-linenos="734 "></span></a>        <span class="c1">################################################################################</span>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a><a href="#__codelineno-0-735"><span class="linenos" data-linenos="735 "></span></a>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a><a href="#__codelineno-0-736"><span class="linenos" data-linenos="736 "></span></a>        <span class="n">match_i</span><span class="p">,</span> <span class="n">match_j</span> <span class="o">=</span> <span class="n">linear_sum_assignment</span><span class="p">((</span><span class="o">-</span><span class="n">traj_score</span><span class="p">))</span>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a><a href="#__codelineno-0-737"><span class="linenos" data-linenos="737 "></span></a>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a><a href="#__codelineno-0-738"><span class="linenos" data-linenos="738 "></span></a>        <span class="n">track_ids</span> <span class="o">=</span> <span class="n">instance_ids</span><span class="o">.</span><span class="n">new_full</span><span class="p">((</span><span class="n">n_query</span><span class="p">,),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a><a href="#__codelineno-0-739"><span class="linenos" data-linenos="739 "></span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">match_i</span><span class="p">,</span> <span class="n">match_j</span><span class="p">):</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a><a href="#__codelineno-0-740"><span class="linenos" data-linenos="740 "></span></a>            <span class="c1"># The overlap threshold is multiplied by the number of times the unique track j is matched to an</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a><a href="#__codelineno-0-741"><span class="linenos" data-linenos="741 "></span></a>            <span class="c1"># instance out of all instances in the window excluding the current frame.</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a><a href="#__codelineno-0-742"><span class="linenos" data-linenos="742 "></span></a>            <span class="c1">#</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a><a href="#__codelineno-0-743"><span class="linenos" data-linenos="743 "></span></a>            <span class="c1"># So if this is correct, the threshold is higher for matching an instance from the current frame</span>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a><a href="#__codelineno-0-744"><span class="linenos" data-linenos="744 "></span></a>            <span class="c1"># to an existing track if that track has already been matched several times.</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a><a href="#__codelineno-0-745"><span class="linenos" data-linenos="745 "></span></a>            <span class="c1"># So if an existing track in the window has been matched a lot, it gets harder to match to that track.</span>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a><a href="#__codelineno-0-746"><span class="linenos" data-linenos="746 "></span></a>            <span class="n">thresh</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a><a href="#__codelineno-0-747"><span class="linenos" data-linenos="747 "></span></a>                <span class="n">overlap_thresh</span> <span class="o">*</span> <span class="n">id_inds</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">if</span> <span class="n">mult_thresh</span> <span class="k">else</span> <span class="n">overlap_thresh</span>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a><a href="#__codelineno-0-748"><span class="linenos" data-linenos="748 "></span></a>            <span class="p">)</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a><a href="#__codelineno-0-749"><span class="linenos" data-linenos="749 "></span></a>            <span class="k">if</span> <span class="n">n_traj</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_tracks</span> <span class="ow">or</span> <span class="n">traj_score</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">:</span>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a><a href="#__codelineno-0-750"><span class="linenos" data-linenos="750 "></span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a><a href="#__codelineno-0-751"><span class="linenos" data-linenos="751 "></span></a>                    <span class="sa">f</span><span class="s2">&quot;Assigning instance </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> to track </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2"> with id </span><span class="si">{</span><span class="n">unique_ids</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a><a href="#__codelineno-0-752"><span class="linenos" data-linenos="752 "></span></a>                <span class="p">)</span>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a><a href="#__codelineno-0-753"><span class="linenos" data-linenos="753 "></span></a>                <span class="n">track_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique_ids</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a><a href="#__codelineno-0-754"><span class="linenos" data-linenos="754 "></span></a>                <span class="n">query_frame</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">track_score</span> <span class="o">=</span> <span class="n">scaled_traj_score</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a><a href="#__codelineno-0-755"><span class="linenos" data-linenos="755 "></span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;track_ids: </span><span class="si">{</span><span class="n">track_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a><a href="#__codelineno-0-756"><span class="linenos" data-linenos="756 "></span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_query</span><span class="p">):</span>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a><a href="#__codelineno-0-757"><span class="linenos" data-linenos="757 "></span></a>            <span class="k">if</span> <span class="n">track_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a><a href="#__codelineno-0-758"><span class="linenos" data-linenos="758 "></span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating new track </span><span class="si">{</span><span class="n">curr_track</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a><a href="#__codelineno-0-759"><span class="linenos" data-linenos="759 "></span></a>                <span class="n">curr_track</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a><a href="#__codelineno-0-760"><span class="linenos" data-linenos="760 "></span></a>                <span class="n">track_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_track</span>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a><a href="#__codelineno-0-761"><span class="linenos" data-linenos="761 "></span></a>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a><a href="#__codelineno-0-762"><span class="linenos" data-linenos="762 "></span></a>        <span class="n">query_frame</span><span class="o">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">(</span><span class="n">match_i</span><span class="p">,</span> <span class="n">match_j</span><span class="p">)</span>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a><a href="#__codelineno-0-763"><span class="linenos" data-linenos="763 "></span></a>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a><a href="#__codelineno-0-764"><span class="linenos" data-linenos="764 "></span></a>        <span class="k">for</span> <span class="n">instance</span><span class="p">,</span> <span class="n">track_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">query_frame</span><span class="o">.</span><span class="n">instances</span><span class="p">,</span> <span class="n">track_ids</span><span class="p">):</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a><a href="#__codelineno-0-765"><span class="linenos" data-linenos="765 "></span></a>            <span class="n">instance</span><span class="o">.</span><span class="n">pred_track_id</span> <span class="o">=</span> <span class="n">track_id</span>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a><a href="#__codelineno-0-766"><span class="linenos" data-linenos="766 "></span></a>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a><a href="#__codelineno-0-767"><span class="linenos" data-linenos="767 "></span></a>        <span class="n">final_traj_score</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a><a href="#__codelineno-0-768"><span class="linenos" data-linenos="768 "></span></a>            <span class="n">traj_score</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="n">unique_ids</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a><a href="#__codelineno-0-769"><span class="linenos" data-linenos="769 "></span></a>        <span class="p">)</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a><a href="#__codelineno-0-770"><span class="linenos" data-linenos="770 "></span></a>        <span class="n">final_traj_score</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Current Frame Instances&quot;</span>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a><a href="#__codelineno-0-771"><span class="linenos" data-linenos="771 "></span></a>        <span class="n">final_traj_score</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Unique IDs&quot;</span>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a><a href="#__codelineno-0-772"><span class="linenos" data-linenos="772 "></span></a>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a><a href="#__codelineno-0-773"><span class="linenos" data-linenos="773 "></span></a>        <span class="n">query_frame</span><span class="o">.</span><span class="n">add_traj_score</span><span class="p">(</span><span class="s2">&quot;final&quot;</span><span class="p">,</span> <span class="n">final_traj_score</span><span class="p">)</span>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a><a href="#__codelineno-0-774"><span class="linenos" data-linenos="774 "></span></a>        <span class="k">return</span> <span class="n">query_frame</span>
</code></pre></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="dreem.inference.batch_tracker.BatchTracker.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">frames</span><span class="p">)</span></code>

<a href="#dreem.inference.batch_tracker.BatchTracker.__call__" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Wrap around <code>track</code> to enable <code>tracker()</code> instead of <code>tracker.track()</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;code&gt;dreem.models.GlobalTrackingTransformer&lt;/code&gt;" href="../../../../models/global_tracking_transformer/#dreem.models.GlobalTrackingTransformer">GlobalTrackingTransformer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the pretrained GlobalTrackingTransformer to be used for inference</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>frames</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="&lt;code&gt;dreem.io.Frame&lt;/code&gt;" href="../../../../io/frame/#dreem.io.Frame">Frame</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of Frames to run inference on</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="&lt;code&gt;dreem.io.Frame&lt;/code&gt;" href="../../../../io/frame/#dreem.io.Frame">Frame</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of frames containing association matrix scores and instances populated with pred track ids.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>dreem/inference/batch_tracker.py</code></summary>
              <div class="highlight"><pre><span></span><code><a id="__codelineno-0-68" name="__codelineno-0-68"></a><a href="#__codelineno-0-68"><span class="linenos" data-linenos=" 68 "></span></a><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><a href="#__codelineno-0-69"><span class="linenos" data-linenos=" 69 "></span></a>    <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">GlobalTrackingTransformer</span><span class="p">,</span> <span class="n">frames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Frame</span><span class="p">]</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><a href="#__codelineno-0-70"><span class="linenos" data-linenos=" 70 "></span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Frame</span><span class="p">]:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><a href="#__codelineno-0-71"><span class="linenos" data-linenos=" 71 "></span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrap around `track` to enable `tracker()` instead of `tracker.track()`.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><a href="#__codelineno-0-72"><span class="linenos" data-linenos=" 72 "></span></a>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><a href="#__codelineno-0-73"><span class="linenos" data-linenos=" 73 "></span></a><span class="sd">    Args:</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><a href="#__codelineno-0-74"><span class="linenos" data-linenos=" 74 "></span></a><span class="sd">        model: the pretrained GlobalTrackingTransformer to be used for inference</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><a href="#__codelineno-0-75"><span class="linenos" data-linenos=" 75 "></span></a><span class="sd">        frames: list of Frames to run inference on</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><a href="#__codelineno-0-76"><span class="linenos" data-linenos=" 76 "></span></a>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><a href="#__codelineno-0-77"><span class="linenos" data-linenos=" 77 "></span></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><a href="#__codelineno-0-78"><span class="linenos" data-linenos=" 78 "></span></a><span class="sd">        List of frames containing association matrix scores and instances populated with pred track ids.</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><a href="#__codelineno-0-79"><span class="linenos" data-linenos=" 79 "></span></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><a href="#__codelineno-0-80"><span class="linenos" data-linenos=" 80 "></span></a>    <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><a href="#__codelineno-0-81"><span class="linenos" data-linenos=" 81 "></span></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><a href="#__codelineno-0-82"><span class="linenos" data-linenos=" 82 "></span></a>    <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><a href="#__codelineno-0-83"><span class="linenos" data-linenos=" 83 "></span></a>        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">has_instances</span><span class="p">():</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><a href="#__codelineno-0-84"><span class="linenos" data-linenos=" 84 "></span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_vis_feats</span><span class="p">:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><a href="#__codelineno-0-85"><span class="linenos" data-linenos=" 85 "></span></a>                <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><a href="#__codelineno-0-86"><span class="linenos" data-linenos=" 86 "></span></a>                    <span class="n">instance</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">d_model</span><span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><a href="#__codelineno-0-87"><span class="linenos" data-linenos=" 87 "></span></a>                <span class="c1"># frame[&quot;features&quot;] = torch.randn(</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><a href="#__codelineno-0-88"><span class="linenos" data-linenos=" 88 "></span></a>                <span class="c1">#     num_frame_instances, self.model.d_model</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><a href="#__codelineno-0-89"><span class="linenos" data-linenos=" 89 "></span></a>                <span class="c1"># )</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><a href="#__codelineno-0-90"><span class="linenos" data-linenos=" 90 "></span></a>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><a href="#__codelineno-0-91"><span class="linenos" data-linenos=" 91 "></span></a>            <span class="c1"># comment out to turn encoder off</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><a href="#__codelineno-0-92"><span class="linenos" data-linenos=" 92 "></span></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><a href="#__codelineno-0-93"><span class="linenos" data-linenos=" 93 "></span></a>            <span class="c1"># Assuming the encoder is already trained or train encoder jointly.</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><a href="#__codelineno-0-94"><span class="linenos" data-linenos=" 94 "></span></a>            <span class="k">elif</span> <span class="ow">not</span> <span class="n">frame</span><span class="o">.</span><span class="n">has_features</span><span class="p">():</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><a href="#__codelineno-0-95"><span class="linenos" data-linenos=" 95 "></span></a>                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><a href="#__codelineno-0-96"><span class="linenos" data-linenos=" 96 "></span></a>                    <span class="n">crops</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">get_crops</span><span class="p">()</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><a href="#__codelineno-0-97"><span class="linenos" data-linenos=" 97 "></span></a>                    <span class="n">z</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">visual_encoder</span><span class="p">(</span><span class="n">crops</span><span class="p">)</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><a href="#__codelineno-0-98"><span class="linenos" data-linenos=" 98 "></span></a>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><a href="#__codelineno-0-99"><span class="linenos" data-linenos=" 99 "></span></a>                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">z_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><a href="#__codelineno-0-100"><span class="linenos" data-linenos="100 "></span></a>                        <span class="n">frame</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">z_i</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><a href="#__codelineno-0-101"><span class="linenos" data-linenos="101 "></span></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><a href="#__codelineno-0-102"><span class="linenos" data-linenos="102 "></span></a>    <span class="n">instances_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">frames</span><span class="p">)</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><a href="#__codelineno-0-103"><span class="linenos" data-linenos="103 "></span></a>    <span class="c1"># no more persistent tracking. It is on by default</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><a href="#__codelineno-0-104"><span class="linenos" data-linenos="104 "></span></a>    <span class="c1"># if not self.persistent_tracking:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><a href="#__codelineno-0-105"><span class="linenos" data-linenos="105 "></span></a>    <span class="c1">#     logger.debug(f&quot;Clearing Queue after tracking&quot;)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><a href="#__codelineno-0-106"><span class="linenos" data-linenos="106 "></span></a>    <span class="c1">#     self.track_queue.end_tracks()</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><a href="#__codelineno-0-107"><span class="linenos" data-linenos="107 "></span></a>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><a href="#__codelineno-0-108"><span class="linenos" data-linenos="108 "></span></a>    <span class="k">return</span> <span class="n">instances_pred</span>
</code></pre></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="dreem.inference.batch_tracker.BatchTracker.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">use_vis_feats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overlap_thresh</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">mult_thresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">decay_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iou</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_center_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">persistent_tracking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_gap</span><span class="o">=</span><span class="n">inf</span><span class="p">,</span> <span class="n">max_tracks</span><span class="o">=</span><span class="n">inf</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#dreem.inference.batch_tracker.BatchTracker.__init__" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Initialize a tracker to run inference.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>window_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the size of the window used during sliding inference.</p>
              </div>
            </td>
            <td>
                  <code>8</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_vis_feats</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether or not to use visual feature extractor.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>overlap_thresh</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the trajectory overlap threshold to be used for assignment.</p>
              </div>
            </td>
            <td>
                  <code>0.01</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mult_thresh</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether or not to use weight threshold.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>decay_time</code>
            </td>
            <td>
                  <code><span title="float">float</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>weight for <code>decay_time</code> postprocessing.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>iou</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either [None, '', "mult" or "max"]
 Whether to use multiplicative or max iou reweighting.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_center_dist</code>
            </td>
            <td>
                  <code><span title="float">float</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>distance threshold for filtering trajectory score matrix.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>persistent_tracking</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to keep a buffer across chunks or not.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_gap</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the max number of frames a trajectory can be missing before termination.</p>
              </div>
            </td>
            <td>
                  <code><span title="math.inf">inf</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_tracks</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the maximum number of tracks that can be created while tracking.
We force the tracker to assign instances to a track instead of creating a new track if max_tracks has been reached.</p>
              </div>
            </td>
            <td>
                  <code><span title="math.inf">inf</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether or not to turn on debug printing after each operation.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>dreem/inference/batch_tracker.py</code></summary>
              <div class="highlight"><pre><span></span><code><a id="__codelineno-0-21" name="__codelineno-0-21"></a><a href="#__codelineno-0-21"><span class="linenos" data-linenos="21 "></span></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><a href="#__codelineno-0-22"><span class="linenos" data-linenos="22 "></span></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><a href="#__codelineno-0-23"><span class="linenos" data-linenos="23 "></span></a>    <span class="n">window_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><a href="#__codelineno-0-24"><span class="linenos" data-linenos="24 "></span></a>    <span class="n">use_vis_feats</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><a href="#__codelineno-0-25"><span class="linenos" data-linenos="25 "></span></a>    <span class="n">overlap_thresh</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><a href="#__codelineno-0-26"><span class="linenos" data-linenos="26 "></span></a>    <span class="n">mult_thresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><a href="#__codelineno-0-27"><span class="linenos" data-linenos="27 "></span></a>    <span class="n">decay_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><a href="#__codelineno-0-28"><span class="linenos" data-linenos="28 "></span></a>    <span class="n">iou</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><a href="#__codelineno-0-29"><span class="linenos" data-linenos="29 "></span></a>    <span class="n">max_center_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><a href="#__codelineno-0-30"><span class="linenos" data-linenos="30 "></span></a>    <span class="n">persistent_tracking</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><a href="#__codelineno-0-31"><span class="linenos" data-linenos="31 "></span></a>    <span class="n">max_gap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">inf</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><a href="#__codelineno-0-32"><span class="linenos" data-linenos="32 "></span></a>    <span class="n">max_tracks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">inf</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><a href="#__codelineno-0-33"><span class="linenos" data-linenos="33 "></span></a>    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><a href="#__codelineno-0-34"><span class="linenos" data-linenos="34 "></span></a>    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><a href="#__codelineno-0-35"><span class="linenos" data-linenos="35 "></span></a><span class="p">):</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><a href="#__codelineno-0-36"><span class="linenos" data-linenos="36 "></span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize a tracker to run inference.</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><a href="#__codelineno-0-37"><span class="linenos" data-linenos="37 "></span></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><a href="#__codelineno-0-38"><span class="linenos" data-linenos="38 "></span></a><span class="sd">    Args:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><a href="#__codelineno-0-39"><span class="linenos" data-linenos="39 "></span></a><span class="sd">        window_size: the size of the window used during sliding inference.</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><a href="#__codelineno-0-40"><span class="linenos" data-linenos="40 "></span></a><span class="sd">        use_vis_feats: Whether or not to use visual feature extractor.</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><a href="#__codelineno-0-41"><span class="linenos" data-linenos="41 "></span></a><span class="sd">        overlap_thresh: the trajectory overlap threshold to be used for assignment.</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><a href="#__codelineno-0-42"><span class="linenos" data-linenos="42 "></span></a><span class="sd">        mult_thresh: Whether or not to use weight threshold.</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><a href="#__codelineno-0-43"><span class="linenos" data-linenos="43 "></span></a><span class="sd">        decay_time: weight for `decay_time` postprocessing.</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><a href="#__codelineno-0-44"><span class="linenos" data-linenos="44 "></span></a><span class="sd">        iou: Either [None, &#39;&#39;, &quot;mult&quot; or &quot;max&quot;]</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><a href="#__codelineno-0-45"><span class="linenos" data-linenos="45 "></span></a><span class="sd">             Whether to use multiplicative or max iou reweighting.</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><a href="#__codelineno-0-46"><span class="linenos" data-linenos="46 "></span></a><span class="sd">        max_center_dist: distance threshold for filtering trajectory score matrix.</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><a href="#__codelineno-0-47"><span class="linenos" data-linenos="47 "></span></a><span class="sd">        persistent_tracking: whether to keep a buffer across chunks or not.</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><a href="#__codelineno-0-48"><span class="linenos" data-linenos="48 "></span></a><span class="sd">        max_gap: the max number of frames a trajectory can be missing before termination.</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><a href="#__codelineno-0-49"><span class="linenos" data-linenos="49 "></span></a><span class="sd">        max_tracks: the maximum number of tracks that can be created while tracking.</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><a href="#__codelineno-0-50"><span class="linenos" data-linenos="50 "></span></a><span class="sd">            We force the tracker to assign instances to a track instead of creating a new track if max_tracks has been reached.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><a href="#__codelineno-0-51"><span class="linenos" data-linenos="51 "></span></a><span class="sd">        verbose: Whether or not to turn on debug printing after each operation.</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><a href="#__codelineno-0-52"><span class="linenos" data-linenos="52 "></span></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><a href="#__codelineno-0-53"><span class="linenos" data-linenos="53 "></span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span> <span class="o">=</span> <span class="n">TrackQueue</span><span class="p">(</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><a href="#__codelineno-0-54"><span class="linenos" data-linenos="54 "></span></a>        <span class="n">window_size</span><span class="o">=</span><span class="n">window_size</span><span class="p">,</span> <span class="n">max_gap</span><span class="o">=</span><span class="n">max_gap</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><a href="#__codelineno-0-55"><span class="linenos" data-linenos="55 "></span></a>    <span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><a href="#__codelineno-0-56"><span class="linenos" data-linenos="56 "></span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">num_frames_tracked</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><a href="#__codelineno-0-57"><span class="linenos" data-linenos="57 "></span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">=</span> <span class="n">window_size</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><a href="#__codelineno-0-58"><span class="linenos" data-linenos="58 "></span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">use_vis_feats</span> <span class="o">=</span> <span class="n">use_vis_feats</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><a href="#__codelineno-0-59"><span class="linenos" data-linenos="59 "></span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">overlap_thresh</span> <span class="o">=</span> <span class="n">overlap_thresh</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><a href="#__codelineno-0-60"><span class="linenos" data-linenos="60 "></span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">mult_thresh</span> <span class="o">=</span> <span class="n">mult_thresh</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><a href="#__codelineno-0-61"><span class="linenos" data-linenos="61 "></span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">decay_time</span> <span class="o">=</span> <span class="n">decay_time</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><a href="#__codelineno-0-62"><span class="linenos" data-linenos="62 "></span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">iou</span> <span class="o">=</span> <span class="n">iou</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><a href="#__codelineno-0-63"><span class="linenos" data-linenos="63 "></span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">max_center_dist</span> <span class="o">=</span> <span class="n">max_center_dist</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><a href="#__codelineno-0-64"><span class="linenos" data-linenos="64 "></span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">persistent_tracking</span> <span class="o">=</span> <span class="n">persistent_tracking</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><a href="#__codelineno-0-65"><span class="linenos" data-linenos="65 "></span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><a href="#__codelineno-0-66"><span class="linenos" data-linenos="66 "></span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">max_tracks</span> <span class="o">=</span> <span class="n">max_tracks</span>
</code></pre></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="dreem.inference.batch_tracker.BatchTracker.__repr__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>

<a href="#dreem.inference.batch_tracker.BatchTracker.__repr__" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Get string representation of tracker.</p>
<p>Returns: the string representation of the tracker</p>


            <details class="quote">
              <summary>Source code in <code>dreem/inference/batch_tracker.py</code></summary>
              <div class="highlight"><pre><span></span><code><a id="__codelineno-0-110" name="__codelineno-0-110"></a><a href="#__codelineno-0-110"><span class="linenos" data-linenos="110 "></span></a><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><a href="#__codelineno-0-111"><span class="linenos" data-linenos="111 "></span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get string representation of tracker.</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><a href="#__codelineno-0-112"><span class="linenos" data-linenos="112 "></span></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><a href="#__codelineno-0-113"><span class="linenos" data-linenos="113 "></span></a><span class="sd">    Returns: the string representation of the tracker</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><a href="#__codelineno-0-114"><span class="linenos" data-linenos="114 "></span></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><a href="#__codelineno-0-115"><span class="linenos" data-linenos="115 "></span></a>    <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><a href="#__codelineno-0-116"><span class="linenos" data-linenos="116 "></span></a>        <span class="s2">&quot;Tracker(&quot;</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><a href="#__codelineno-0-117"><span class="linenos" data-linenos="117 "></span></a>        <span class="sa">f</span><span class="s2">&quot;persistent_tracking=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">persistent_tracking</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><a href="#__codelineno-0-118"><span class="linenos" data-linenos="118 "></span></a>        <span class="sa">f</span><span class="s2">&quot;max_tracks=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_tracks</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><a href="#__codelineno-0-119"><span class="linenos" data-linenos="119 "></span></a>        <span class="sa">f</span><span class="s2">&quot;use_vis_feats=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">use_vis_feats</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><a href="#__codelineno-0-120"><span class="linenos" data-linenos="120 "></span></a>        <span class="sa">f</span><span class="s2">&quot;overlap_thresh=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">overlap_thresh</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><a href="#__codelineno-0-121"><span class="linenos" data-linenos="121 "></span></a>        <span class="sa">f</span><span class="s2">&quot;mult_thresh=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mult_thresh</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><a href="#__codelineno-0-122"><span class="linenos" data-linenos="122 "></span></a>        <span class="sa">f</span><span class="s2">&quot;decay_time=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">decay_time</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><a href="#__codelineno-0-123"><span class="linenos" data-linenos="123 "></span></a>        <span class="sa">f</span><span class="s2">&quot;max_center_dist=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_center_dist</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><a href="#__codelineno-0-124"><span class="linenos" data-linenos="124 "></span></a>        <span class="sa">f</span><span class="s2">&quot;verbose=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><a href="#__codelineno-0-125"><span class="linenos" data-linenos="125 "></span></a>        <span class="sa">f</span><span class="s2">&quot;queue=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><a href="#__codelineno-0-126"><span class="linenos" data-linenos="126 "></span></a>    <span class="p">)</span>
</code></pre></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="dreem.inference.batch_tracker.BatchTracker.track" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">track</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">frames</span><span class="p">)</span></code>

<a href="#dreem.inference.batch_tracker.BatchTracker.track" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Perform sliding inference on the input video (instances) with a given window size. This method is called once per batch.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;code&gt;dreem.models.GlobalTrackingTransformer&lt;/code&gt;" href="../../../../models/global_tracking_transformer/#dreem.models.GlobalTrackingTransformer">GlobalTrackingTransformer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the pretrained GlobalTrackingTransformer to be used for inference</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>frames</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="&lt;code&gt;dreem.io.Frame&lt;/code&gt;" href="../../../../io/frame/#dreem.io.Frame">Frame</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of Frames (See <code>dreem.io.Frame</code> for more info).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>frames</code></td>            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="&lt;code&gt;dreem.io.Frame&lt;/code&gt;" href="../../../../io/frame/#dreem.io.Frame">Frame</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of Frames populated with pred_track_ids and asso_matrices</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>dreem/inference/batch_tracker.py</code></summary>
              <div class="highlight"><pre><span></span><code><a id="__codelineno-0-128" name="__codelineno-0-128"></a><a href="#__codelineno-0-128"><span class="linenos" data-linenos="128 "></span></a><span class="k">def</span><span class="w"> </span><span class="nf">track</span><span class="p">(</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><a href="#__codelineno-0-129"><span class="linenos" data-linenos="129 "></span></a>    <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">GlobalTrackingTransformer</span><span class="p">,</span> <span class="n">frames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Frame</span><span class="p">]</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><a href="#__codelineno-0-130"><span class="linenos" data-linenos="130 "></span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Frame</span><span class="p">]:</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><a href="#__codelineno-0-131"><span class="linenos" data-linenos="131 "></span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform sliding inference on the input video (instances) with a given window size. This method is called once per batch.</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><a href="#__codelineno-0-132"><span class="linenos" data-linenos="132 "></span></a>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><a href="#__codelineno-0-133"><span class="linenos" data-linenos="133 "></span></a><span class="sd">    Args:</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><a href="#__codelineno-0-134"><span class="linenos" data-linenos="134 "></span></a><span class="sd">        model: the pretrained GlobalTrackingTransformer to be used for inference</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><a href="#__codelineno-0-135"><span class="linenos" data-linenos="135 "></span></a><span class="sd">        frames: A list of Frames (See `dreem.io.Frame` for more info).</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><a href="#__codelineno-0-136"><span class="linenos" data-linenos="136 "></span></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><a href="#__codelineno-0-137"><span class="linenos" data-linenos="137 "></span></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><a href="#__codelineno-0-138"><span class="linenos" data-linenos="138 "></span></a><span class="sd">        frames: A list of Frames populated with pred_track_ids and asso_matrices</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><a href="#__codelineno-0-139"><span class="linenos" data-linenos="139 "></span></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><a href="#__codelineno-0-140"><span class="linenos" data-linenos="140 "></span></a>    <span class="c1"># all batches up until context_length number of frames have been tracked, will be tracked frame-by-frame</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><a href="#__codelineno-0-141"><span class="linenos" data-linenos="141 "></span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_frames_tracked</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">:</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><a href="#__codelineno-0-142"><span class="linenos" data-linenos="142 "></span></a>        <span class="n">frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_by_frame</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">frames</span><span class="p">)</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><a href="#__codelineno-0-143"><span class="linenos" data-linenos="143 "></span></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><a href="#__codelineno-0-144"><span class="linenos" data-linenos="144 "></span></a>        <span class="n">frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_by_batch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">frames</span><span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><a href="#__codelineno-0-145"><span class="linenos" data-linenos="145 "></span></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><a href="#__codelineno-0-146"><span class="linenos" data-linenos="146 "></span></a>    <span class="k">return</span> <span class="n">frames</span>
</code></pre></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="dreem.inference.batch_tracker.BatchTracker.track_by_batch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">track_by_batch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">frames</span><span class="p">)</span></code>

<a href="#dreem.inference.batch_tracker.BatchTracker.track_by_batch" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Perform sliding inference, on an entire batch of frames, on the input video (instances) with a given context length (window size).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;code&gt;dreem.models.GlobalTrackingTransformer&lt;/code&gt;" href="../../../../models/global_tracking_transformer/#dreem.models.GlobalTrackingTransformer">GlobalTrackingTransformer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the pretrained GlobalTrackingTransformer to be used for inference</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>frames</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="&lt;code&gt;dreem.io.Frame&lt;/code&gt;" href="../../../../io/frame/#dreem.io.Frame">Frame</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of Frames (See <code>dreem.io.Frame</code> for more info).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>frames</code></td>            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="&lt;code&gt;dreem.io.Frame&lt;/code&gt;" href="../../../../io/frame/#dreem.io.Frame">Frame</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of Frames populated with pred_track_ids and asso_matrices</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>dreem/inference/batch_tracker.py</code></summary>
              <div class="highlight"><pre><span></span><code><a id="__codelineno-0-148" name="__codelineno-0-148"></a><a href="#__codelineno-0-148"><span class="linenos" data-linenos="148 "></span></a><span class="k">def</span><span class="w"> </span><span class="nf">track_by_batch</span><span class="p">(</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><a href="#__codelineno-0-149"><span class="linenos" data-linenos="149 "></span></a>    <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">GlobalTrackingTransformer</span><span class="p">,</span> <span class="n">frames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Frame</span><span class="p">]</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><a href="#__codelineno-0-150"><span class="linenos" data-linenos="150 "></span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Frame</span><span class="p">]:</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><a href="#__codelineno-0-151"><span class="linenos" data-linenos="151 "></span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform sliding inference, on an entire batch of frames, on the input video (instances) with a given context length (window size).</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><a href="#__codelineno-0-152"><span class="linenos" data-linenos="152 "></span></a>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><a href="#__codelineno-0-153"><span class="linenos" data-linenos="153 "></span></a><span class="sd">    Args:</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><a href="#__codelineno-0-154"><span class="linenos" data-linenos="154 "></span></a><span class="sd">        model: the pretrained GlobalTrackingTransformer to be used for inference</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><a href="#__codelineno-0-155"><span class="linenos" data-linenos="155 "></span></a><span class="sd">        frames: A list of Frames (See `dreem.io.Frame` for more info).</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><a href="#__codelineno-0-156"><span class="linenos" data-linenos="156 "></span></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><a href="#__codelineno-0-157"><span class="linenos" data-linenos="157 "></span></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><a href="#__codelineno-0-158"><span class="linenos" data-linenos="158 "></span></a><span class="sd">        frames: A list of Frames populated with pred_track_ids and asso_matrices</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><a href="#__codelineno-0-159"><span class="linenos" data-linenos="159 "></span></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><a href="#__codelineno-0-160"><span class="linenos" data-linenos="160 "></span></a>    <span class="c1"># context window starts from last frame just before start of current batch, to window_size frames preceding it</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><a href="#__codelineno-0-161"><span class="linenos" data-linenos="161 "></span></a>    <span class="c1"># note; can&#39;t use last frame of previous batch, because there could be empty frames in between batches that must</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><a href="#__codelineno-0-162"><span class="linenos" data-linenos="162 "></span></a>    <span class="c1"># be part of the context window for consistency</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><a href="#__codelineno-0-163"><span class="linenos" data-linenos="163 "></span></a>    <span class="n">context_window_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span><span class="o">.</span><span class="n">collate_tracks</span><span class="p">(</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><a href="#__codelineno-0-164"><span class="linenos" data-linenos="164 "></span></a>        <span class="n">context_start_frame_id</span><span class="o">=</span><span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">frame_id</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><a href="#__codelineno-0-165"><span class="linenos" data-linenos="165 "></span></a>        <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># switched off in collate_tracks; there is no cutoff for context, only until the deque gets filled</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><a href="#__codelineno-0-166"><span class="linenos" data-linenos="166 "></span></a>        <span class="n">device</span><span class="o">=</span><span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">frame_id</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><a href="#__codelineno-0-167"><span class="linenos" data-linenos="167 "></span></a>    <span class="p">)</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><a href="#__codelineno-0-168"><span class="linenos" data-linenos="168 "></span></a>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><a href="#__codelineno-0-169"><span class="linenos" data-linenos="169 "></span></a>    <span class="n">context_window_instances</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><a href="#__codelineno-0-170"><span class="linenos" data-linenos="170 "></span></a>    <span class="n">context_window_instance_frame_ids</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><a href="#__codelineno-0-171"><span class="linenos" data-linenos="171 "></span></a>    <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">context_window_frames</span><span class="p">:</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><a href="#__codelineno-0-172"><span class="linenos" data-linenos="172 "></span></a>        <span class="n">context_window_instances</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">instances</span><span class="p">)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><a href="#__codelineno-0-173"><span class="linenos" data-linenos="173 "></span></a>        <span class="n">context_window_instance_frame_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><a href="#__codelineno-0-174"><span class="linenos" data-linenos="174 "></span></a>            <span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">frame_id</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">instances</span><span class="p">)</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><a href="#__codelineno-0-175"><span class="linenos" data-linenos="175 "></span></a>        <span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><a href="#__codelineno-0-176"><span class="linenos" data-linenos="176 "></span></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><a href="#__codelineno-0-177"><span class="linenos" data-linenos="177 "></span></a>    <span class="n">current_batch_instances</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><a href="#__codelineno-0-178"><span class="linenos" data-linenos="178 "></span></a>    <span class="n">current_batch_instance_frame_ids</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><a href="#__codelineno-0-179"><span class="linenos" data-linenos="179 "></span></a>    <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><a href="#__codelineno-0-180"><span class="linenos" data-linenos="180 "></span></a>        <span class="n">current_batch_instances</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">instances</span><span class="p">)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><a href="#__codelineno-0-181"><span class="linenos" data-linenos="181 "></span></a>        <span class="n">current_batch_instance_frame_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><a href="#__codelineno-0-182"><span class="linenos" data-linenos="182 "></span></a>            <span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">frame_id</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">instances</span><span class="p">)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><a href="#__codelineno-0-183"><span class="linenos" data-linenos="183 "></span></a>        <span class="p">)</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a><a href="#__codelineno-0-184"><span class="linenos" data-linenos="184 "></span></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><a href="#__codelineno-0-185"><span class="linenos" data-linenos="185 "></span></a>    <span class="n">frames_to_track</span> <span class="o">=</span> <span class="n">context_window_frames</span> <span class="o">+</span> <span class="n">frames</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a><a href="#__codelineno-0-186"><span class="linenos" data-linenos="186 "></span></a>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a><a href="#__codelineno-0-187"><span class="linenos" data-linenos="187 "></span></a>    <span class="c1"># query is current batch instances, key is context window and current batch instances</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a><a href="#__codelineno-0-188"><span class="linenos" data-linenos="188 "></span></a>    <span class="n">association_matrix</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a><a href="#__codelineno-0-189"><span class="linenos" data-linenos="189 "></span></a>        <span class="n">context_window_instances</span> <span class="o">+</span> <span class="n">current_batch_instances</span><span class="p">,</span> <span class="n">current_batch_instances</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a><a href="#__codelineno-0-190"><span class="linenos" data-linenos="190 "></span></a>    <span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a><a href="#__codelineno-0-191"><span class="linenos" data-linenos="191 "></span></a>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><a href="#__codelineno-0-192"><span class="linenos" data-linenos="192 "></span></a>    <span class="c1"># take association matrix and all frames off GPU (frames include instances)</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><a href="#__codelineno-0-193"><span class="linenos" data-linenos="193 "></span></a>    <span class="n">association_matrix</span> <span class="o">=</span> <span class="n">association_matrix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a><a href="#__codelineno-0-194"><span class="linenos" data-linenos="194 "></span></a>    <span class="n">context_window_frames</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">context_window_frames</span><span class="p">]</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><a href="#__codelineno-0-195"><span class="linenos" data-linenos="195 "></span></a>    <span class="n">frames</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">]</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a><a href="#__codelineno-0-196"><span class="linenos" data-linenos="196 "></span></a>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a><a href="#__codelineno-0-197"><span class="linenos" data-linenos="197 "></span></a>    <span class="c1"># keep current batch instances in assoc matrix, and remove them after softmax (mirrors the training scheme)</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><a href="#__codelineno-0-198"><span class="linenos" data-linenos="198 "></span></a>    <span class="n">pred_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_batch_tracker</span><span class="p">(</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a><a href="#__codelineno-0-199"><span class="linenos" data-linenos="199 "></span></a>        <span class="n">association_matrix</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a><a href="#__codelineno-0-200"><span class="linenos" data-linenos="200 "></span></a>        <span class="n">context_window_frames</span><span class="p">,</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a><a href="#__codelineno-0-201"><span class="linenos" data-linenos="201 "></span></a>        <span class="n">frames</span><span class="p">,</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a><a href="#__codelineno-0-202"><span class="linenos" data-linenos="202 "></span></a>        <span class="n">compute_probs_by_frame</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><a href="#__codelineno-0-203"><span class="linenos" data-linenos="203 "></span></a>    <span class="p">)</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><a href="#__codelineno-0-204"><span class="linenos" data-linenos="204 "></span></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><a href="#__codelineno-0-205"><span class="linenos" data-linenos="205 "></span></a>    <span class="k">return</span> <span class="n">pred_frames</span>
</code></pre></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="dreem.inference.batch_tracker.BatchTracker.track_by_frame" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">track_by_frame</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">frames</span><span class="p">)</span></code>

<a href="#dreem.inference.batch_tracker.BatchTracker.track_by_frame" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Perform sliding inference on the input video (instances) with a given window size.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;code&gt;dreem.models.GlobalTrackingTransformer&lt;/code&gt;" href="../../../../models/global_tracking_transformer/#dreem.models.GlobalTrackingTransformer">GlobalTrackingTransformer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the pretrained GlobalTrackingTransformer to be used for inference</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>frames</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="&lt;code&gt;dreem.io.Frame&lt;/code&gt;" href="../../../../io/frame/#dreem.io.Frame">Frame</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of Frames (See <code>dreem.io.Frame</code> for more info).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>frames</code></td>            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="&lt;code&gt;dreem.io.Frame&lt;/code&gt;" href="../../../../io/frame/#dreem.io.Frame">Frame</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of Frames populated with pred_track_ids and asso_matrices</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>dreem/inference/batch_tracker.py</code></summary>
              <div class="highlight"><pre><span></span><code><a id="__codelineno-0-207" name="__codelineno-0-207"></a><a href="#__codelineno-0-207"><span class="linenos" data-linenos="207 "></span></a><span class="k">def</span><span class="w"> </span><span class="nf">track_by_frame</span><span class="p">(</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><a href="#__codelineno-0-208"><span class="linenos" data-linenos="208 "></span></a>    <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">GlobalTrackingTransformer</span><span class="p">,</span> <span class="n">frames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Frame</span><span class="p">]</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><a href="#__codelineno-0-209"><span class="linenos" data-linenos="209 "></span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Frame</span><span class="p">]:</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><a href="#__codelineno-0-210"><span class="linenos" data-linenos="210 "></span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform sliding inference on the input video (instances) with a given window size.</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><a href="#__codelineno-0-211"><span class="linenos" data-linenos="211 "></span></a>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><a href="#__codelineno-0-212"><span class="linenos" data-linenos="212 "></span></a><span class="sd">    Args:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a><a href="#__codelineno-0-213"><span class="linenos" data-linenos="213 "></span></a><span class="sd">        model: the pretrained GlobalTrackingTransformer to be used for inference</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a><a href="#__codelineno-0-214"><span class="linenos" data-linenos="214 "></span></a><span class="sd">        frames: A list of Frames (See `dreem.io.Frame` for more info).</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a><a href="#__codelineno-0-215"><span class="linenos" data-linenos="215 "></span></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><a href="#__codelineno-0-216"><span class="linenos" data-linenos="216 "></span></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a><a href="#__codelineno-0-217"><span class="linenos" data-linenos="217 "></span></a><span class="sd">        frames: A list of Frames populated with pred_track_ids and asso_matrices</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><a href="#__codelineno-0-218"><span class="linenos" data-linenos="218 "></span></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><a href="#__codelineno-0-219"><span class="linenos" data-linenos="219 "></span></a>    <span class="c1"># B: batch size.</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><a href="#__codelineno-0-220"><span class="linenos" data-linenos="220 "></span></a>    <span class="c1"># D: embedding dimension.</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><a href="#__codelineno-0-221"><span class="linenos" data-linenos="221 "></span></a>    <span class="c1"># nc: number of channels.</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><a href="#__codelineno-0-222"><span class="linenos" data-linenos="222 "></span></a>    <span class="c1"># H: height.</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><a href="#__codelineno-0-223"><span class="linenos" data-linenos="223 "></span></a>    <span class="c1"># W: width.</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a><a href="#__codelineno-0-224"><span class="linenos" data-linenos="224 "></span></a>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a><a href="#__codelineno-0-225"><span class="linenos" data-linenos="225 "></span></a>    <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">frame_to_track</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frames</span><span class="p">):</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><a href="#__codelineno-0-226"><span class="linenos" data-linenos="226 "></span></a>        <span class="c1"># if we&#39;re tracking by frame, it means context length of frames hasn&#39;t been reached yet, so context start frame id is 0</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a><a href="#__codelineno-0-227"><span class="linenos" data-linenos="227 "></span></a>        <span class="n">context_window_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span><span class="o">.</span><span class="n">collate_tracks</span><span class="p">(</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a><a href="#__codelineno-0-228"><span class="linenos" data-linenos="228 "></span></a>            <span class="n">context_start_frame_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">frame_to_track</span><span class="o">.</span><span class="n">frame_id</span><span class="o">.</span><span class="n">device</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a><a href="#__codelineno-0-229"><span class="linenos" data-linenos="229 "></span></a>        <span class="p">)</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a><a href="#__codelineno-0-230"><span class="linenos" data-linenos="230 "></span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current number of tracks is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span><span class="o">.</span><span class="n">n_tracks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a><a href="#__codelineno-0-231"><span class="linenos" data-linenos="231 "></span></a>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a><a href="#__codelineno-0-232"><span class="linenos" data-linenos="232 "></span></a>        <span class="k">if</span> <span class="p">(</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a><a href="#__codelineno-0-233"><span class="linenos" data-linenos="233 "></span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">persistent_tracking</span> <span class="ow">and</span> <span class="n">frame_to_track</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">==</span> <span class="mi">0</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a><a href="#__codelineno-0-234"><span class="linenos" data-linenos="234 "></span></a>        <span class="p">):</span>  <span class="c1"># check for new video and clear queue</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a><a href="#__codelineno-0-235"><span class="linenos" data-linenos="235 "></span></a>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a><a href="#__codelineno-0-236"><span class="linenos" data-linenos="236 "></span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;New Video! Resetting Track Queue.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a><a href="#__codelineno-0-237"><span class="linenos" data-linenos="237 "></span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span><span class="o">.</span><span class="n">end_tracks</span><span class="p">()</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a><a href="#__codelineno-0-238"><span class="linenos" data-linenos="238 "></span></a>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><a href="#__codelineno-0-239"><span class="linenos" data-linenos="239 "></span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><a href="#__codelineno-0-240"><span class="linenos" data-linenos="240 "></span></a><span class="sd">        Initialize tracks on first frame where detections appear. This is the first frame of the first batch</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a><a href="#__codelineno-0-241"><span class="linenos" data-linenos="241 "></span></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><a href="#__codelineno-0-242"><span class="linenos" data-linenos="242 "></span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><a href="#__codelineno-0-243"><span class="linenos" data-linenos="243 "></span></a>            <span class="k">if</span> <span class="n">frame_to_track</span><span class="o">.</span><span class="n">has_instances</span><span class="p">():</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><a href="#__codelineno-0-244"><span class="linenos" data-linenos="244 "></span></a>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><a href="#__codelineno-0-245"><span class="linenos" data-linenos="245 "></span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><a href="#__codelineno-0-246"><span class="linenos" data-linenos="246 "></span></a>                    <span class="sa">f</span><span class="s2">&quot;Initializing track on clip ind </span><span class="si">{</span><span class="n">batch_idx</span><span class="si">}</span><span class="s2"> frame </span><span class="si">{</span><span class="n">frame_to_track</span><span class="o">.</span><span class="n">frame_id</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a><a href="#__codelineno-0-247"><span class="linenos" data-linenos="247 "></span></a>                <span class="p">)</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><a href="#__codelineno-0-248"><span class="linenos" data-linenos="248 "></span></a>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><a href="#__codelineno-0-249"><span class="linenos" data-linenos="249 "></span></a>                <span class="n">curr_track_id</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><a href="#__codelineno-0-250"><span class="linenos" data-linenos="250 "></span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">instance</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">]</span><span class="o">.</span><span class="n">instances</span><span class="p">):</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><a href="#__codelineno-0-251"><span class="linenos" data-linenos="251 "></span></a>                    <span class="n">instance</span><span class="o">.</span><span class="n">pred_track_id</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">gt_track_id</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><a href="#__codelineno-0-252"><span class="linenos" data-linenos="252 "></span></a>                    <span class="n">curr_track_id</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_track_id</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">pred_track_id</span><span class="p">)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><a href="#__codelineno-0-253"><span class="linenos" data-linenos="253 "></span></a>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><a href="#__codelineno-0-254"><span class="linenos" data-linenos="254 "></span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">instance</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">]</span><span class="o">.</span><span class="n">instances</span><span class="p">):</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><a href="#__codelineno-0-255"><span class="linenos" data-linenos="255 "></span></a>                    <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">pred_track_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><a href="#__codelineno-0-256"><span class="linenos" data-linenos="256 "></span></a>                        <span class="n">curr_track_id</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><a href="#__codelineno-0-257"><span class="linenos" data-linenos="257 "></span></a>                        <span class="n">instance</span><span class="o">.</span><span class="n">pred_track_id</span> <span class="o">=</span> <span class="n">curr_track_id</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><a href="#__codelineno-0-258"><span class="linenos" data-linenos="258 "></span></a>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><a href="#__codelineno-0-259"><span class="linenos" data-linenos="259 "></span></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><a href="#__codelineno-0-260"><span class="linenos" data-linenos="260 "></span></a>            <span class="k">if</span> <span class="p">(</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><a href="#__codelineno-0-261"><span class="linenos" data-linenos="261 "></span></a>                <span class="n">frame_to_track</span><span class="o">.</span><span class="n">has_instances</span><span class="p">()</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><a href="#__codelineno-0-262"><span class="linenos" data-linenos="262 "></span></a>            <span class="p">):</span>  <span class="c1"># Check if there are detections. If there are skip and increment gap count</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a><a href="#__codelineno-0-263"><span class="linenos" data-linenos="263 "></span></a>                <span class="n">frames_to_track</span> <span class="o">=</span> <span class="n">context_window_frames</span> <span class="o">+</span> <span class="p">[</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><a href="#__codelineno-0-264"><span class="linenos" data-linenos="264 "></span></a>                    <span class="n">frame_to_track</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><a href="#__codelineno-0-265"><span class="linenos" data-linenos="265 "></span></a>                <span class="p">]</span>  <span class="c1"># better var name?</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><a href="#__codelineno-0-266"><span class="linenos" data-linenos="266 "></span></a>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><a href="#__codelineno-0-267"><span class="linenos" data-linenos="267 "></span></a>                <span class="n">query_ind</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames_to_track</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><a href="#__codelineno-0-268"><span class="linenos" data-linenos="268 "></span></a>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a><a href="#__codelineno-0-269"><span class="linenos" data-linenos="269 "></span></a>                <span class="n">frame_to_track</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_frame_by_frame_tracker</span><span class="p">(</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><a href="#__codelineno-0-270"><span class="linenos" data-linenos="270 "></span></a>                    <span class="n">model</span><span class="p">,</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a><a href="#__codelineno-0-271"><span class="linenos" data-linenos="271 "></span></a>                    <span class="n">frames_to_track</span><span class="p">,</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a><a href="#__codelineno-0-272"><span class="linenos" data-linenos="272 "></span></a>                <span class="p">)</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a><a href="#__codelineno-0-273"><span class="linenos" data-linenos="273 "></span></a>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a><a href="#__codelineno-0-274"><span class="linenos" data-linenos="274 "></span></a>        <span class="k">if</span> <span class="n">frame_to_track</span><span class="o">.</span><span class="n">has_instances</span><span class="p">():</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a><a href="#__codelineno-0-275"><span class="linenos" data-linenos="275 "></span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span><span class="o">.</span><span class="n">add_frame</span><span class="p">(</span><span class="n">frame_to_track</span><span class="p">)</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a><a href="#__codelineno-0-276"><span class="linenos" data-linenos="276 "></span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_frames_tracked</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a><a href="#__codelineno-0-277"><span class="linenos" data-linenos="277 "></span></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a><a href="#__codelineno-0-278"><span class="linenos" data-linenos="278 "></span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">track_queue</span><span class="o">.</span><span class="n">increment_gaps</span><span class="p">([])</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><a href="#__codelineno-0-279"><span class="linenos" data-linenos="279 "></span></a>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a><a href="#__codelineno-0-280"><span class="linenos" data-linenos="280 "></span></a>        <span class="n">frames</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame_to_track</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a><a href="#__codelineno-0-281"><span class="linenos" data-linenos="281 "></span></a>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a><a href="#__codelineno-0-282"><span class="linenos" data-linenos="282 "></span></a>    <span class="k">return</span> <span class="n">frames</span>
</code></pre></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 - 2024 Talmo Lab – <a href="#__consent">Change cookie settings</a>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/talmolab" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/talmop" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9zm-24.8 373.8h39.1L151.1 88h-42z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            



<h4>Cookie consent</h4>
<p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
    
      
        
  
  
    
    
  
  <li class="task-list-item">
    <label class="task-list-control">
      <input type="checkbox" name="analytics" checked>
      <span class="task-list-indicator"></span>
      Google Analytics
    </label>
  </li>

      
    
    
      
        
  
  
    
    
  
  <li class="task-list-item">
    <label class="task-list-control">
      <input type="checkbox" name="github" checked>
      <span class="task-list-indicator"></span>
      GitHub
    </label>
  </li>

      
    
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Accept</button>
    
    
    
  
    
    
      <button type="reset" class="md-button md-button--primary">Reject</button>
    
    
  
    
    
    
      <label class="md-button" for="__settings">Manage settings</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script>
    
    
      
      <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.tracking", "toc.follow", "navigation.sections", "navigation.top", "search.suggest", "search.highlight", "content.code.copy", "content.code.annotate", "content.tooltips", "content.code.select", "content.footnote.tooltips"], "search": "../../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.56ea9cef.min.js"></script>
      
    
  </body>
</html>